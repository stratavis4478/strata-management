<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strata Management Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.1.9/dist/Recharts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <script>
    // Google Drive API Configuration - YOUR CREDENTIALS
    const GOOGLE_CONFIG = {
      apiKey: 'AIzaSyAlhSQp5ZgYJFFBTao9E9pHx57lZvAeBmw',
      clientId: '968897213704-rdjoe3d05fvft9uei1jdl61uto5k6cug.apps.googleusercontent.com',
      appId: '968897213704',
      scope: 'https://www.googleapis.com/auth/drive.file',
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      strataFolderName: 'Strata VIS4478'
    };

    let gapiReady = false;
    let oauthToken;
    
    // Load gapi immediately and wait for it
    function initGoogleAPI() {
      return new Promise((resolve) => {
        gapi.load('client', async () => {
          try {
            await gapi.client.init({
              apiKey: GOOGLE_CONFIG.apiKey,
              discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
            });
            console.log('‚úÖ Google API client initialized');
            gapiReady = true;
            resolve();
          } catch (error) {
            console.error('‚ùå Error initializing Google API:', error);
            resolve(); // Resolve anyway so app loads
          }
        });
      });
    }
    
    // Start loading immediately when page loads
    if (typeof gapi !== 'undefined') {
      initGoogleAPI();
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2B4C7E;
      --primary-dark: #1E3557;
      --accent: #D97D54;
      --accent-light: #F4A261;
      --bg-main: #F8F9FA;
      --bg-card: #FFFFFF;
      --text-primary: #1A1A1A;
      --text-secondary: #6B7280;
      --border: #E5E7EB;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    #root {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .header-content {
      position: relative;
      z-index: 1;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }

    .header-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      font-family: 'Space Mono', monospace;
    }

    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .year-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .year-selector label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .year-selector select {
      padding: 10px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Space Mono', monospace;
    }

    .year-selector select:hover {
      border-color: var(--primary);
    }

    .year-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 76, 126, 0.1);
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      background: var(--bg-card);
      padding: 10px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .tab-button {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .tab-button:hover {
      background: var(--bg-main);
      color: var(--text-primary);
    }

    .tab-button.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .export-buttons {
      display: flex;
      gap: 10px;
    }

    .export-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'DM Sans', sans-serif;
    }

    .export-button.pdf {
      background: var(--danger);
      color: white;
    }

    .export-button.excel {
      background: var(--success);
      color: white;
    }

    .export-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s;
      border-left: 4px solid var(--primary);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.accent {
      border-left-color: var(--accent);
    }

    .stat-card.success {
      border-left-color: var(--success);
    }

    .stat-card.warning {
      border-left-color: var(--warning);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.02em;
    }

    .stat-change {
      font-size: 0.9rem;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow-md);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .add-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .add-button:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
    }

    .add-category-section {
      margin-top: 20px;
      padding: 20px;
      background: #F0F9FF;
      border-radius: 12px;
      border: 2px dashed #BFDBFE;
    }

    .add-category-form {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .add-category-form .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 150px;
    }

    .delete-button {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
    }

    .delete-button:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    th:first-child {
      border-top-left-radius: 10px;
    }

    th:last-child {
      border-top-right-radius: 10px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: var(--bg-main);
    }

    .input-field {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.2s;
      min-width: 100px;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 76, 126, 0.1);
    }

    .input-field::-webkit-inner-spin-button,
    .input-field::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .notes-button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      vertical-align: super;
      margin-left: 4px;
      display: inline-block;
    }

    .notes-button:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(43, 76, 126, 0.05);
    }

    .notes-button.has-note {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .input-with-note {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .notes-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .notes-modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }

    .notes-modal h3 {
      margin-bottom: 15px;
      color: var(--primary);
    }

    .notes-modal textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      resize: vertical;
    }

    .notes-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }

    .modal-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .modal-button.save {
      background: var(--success);
      color: white;
    }

    .modal-button.cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .upload-modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }

    .upload-modal h3 {
      margin-bottom: 20px;
      color: var(--primary);
    }

    .upload-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .total-row {
      font-weight: 700;
      background: linear-gradient(135deg, #F0F4F8 0%, #E2E8F0 100%);
      font-family: 'Space Mono', monospace;
    }

    .total-row td {
      border-bottom: 3px solid var(--primary);
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .month-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border-top: 3px solid var(--accent);
    }

    .month-card h4 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .unit-input {
      margin-bottom: 12px;
    }

    .unit-input label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-weight: 600;
    }

    .chart-container {
      margin-top: 30px;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .simple-chart {
      width: 100%;
      height: 300px;
      position: relative;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .chart-bar {
      flex: 1;
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
      transition: all 0.3s;
    }

    .chart-bar:hover {
      opacity: 0.8;
    }

    .chart-bar.income {
      background: linear-gradient(180deg, var(--success) 0%, #059669 100%);
    }

    .chart-bar.expense {
      background: linear-gradient(180deg, var(--danger) 0%, #dc2626 100%);
    }

    .chart-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .chart-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .badge.warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .nav-tabs {
        flex-wrap: wrap;
      }

      .export-buttons {
        width: 100%;
        flex-direction: column;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .stat-value {
        font-size: 2rem;
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .bar-chart-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .bar-chart-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bar-chart-label {
      width: 150px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .bar-chart-bar-container {
      flex: 1;
      height: 30px;
      background: #e5e7eb;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .bar-chart-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .bar-chart-value {
      min-width: 80px;
      text-align: right;
      font-family: 'Space Mono', monospace;
      font-weight: 600;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Google Drive Integration Module
const GoogleDriveManager = {
  // Initialize and authenticate
  async authenticate() {
    return new Promise((resolve, reject) => {
      // Make sure gapi is loaded
      if (!gapiReady || !gapi.client) {
        reject(new Error('Google API not ready. Please refresh the page.'));
        return;
      }

      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CONFIG.clientId,
        scope: GOOGLE_CONFIG.scope,
        callback: (response) => {
          if (response.error) {
            reject(response);
            return;
          }
          oauthToken = response.access_token;
          gapi.client.setToken({ access_token: oauthToken });
          resolve(response);
        },
      });
      
      tokenClient.requestAccessToken({ prompt: 'consent' });
    });
  },

  // Check if authenticated
  isAuthenticated() {
    return !!oauthToken && !!gapi.client.getToken();
  },

  // Sign out
  signOut() {
    if (oauthToken) {
      google.accounts.oauth2.revoke(oauthToken);
      gapi.client.setToken(null);
      oauthToken = null;
    }
  },

  // Find or create folder
  async findOrCreateFolder(folderName, parentFolderId = null) {
    if (!gapi.client.drive) {
      throw new Error('Drive API not loaded. Please refresh and reconnect.');
    }

    let query = `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    if (parentFolderId) {
      query += ` and '${parentFolderId}' in parents`;
    }

    const response = await gapi.client.drive.files.list({
      q: query,
      fields: 'files(id, name)',
    });

    if (response.result.files && response.result.files.length > 0) {
      return response.result.files[0].id;
    }

    // Create folder
    const folderMetadata = {
      name: folderName,
      mimeType: 'application/vnd.google-apps.folder',
    };
    if (parentFolderId) {
      folderMetadata.parents = [parentFolderId];
    }

    const folder = await gapi.client.drive.files.create({
      resource: folderMetadata,
      fields: 'id',
    });

    return folder.result.id;
  },

  // Get year folder ID
  async getYearFolderId(year) {
    const strataFolderId = await this.findOrCreateFolder(GOOGLE_CONFIG.strataFolderName);
    const yearFolderId = await this.findOrCreateFolder(year.toString(), strataFolderId);
    return yearFolderId;
  },

  // Upload file
  async uploadFile(file, year, metadata) {
    const folderId = await this.getYearFolderId(year);
    
    const fileMetadata = {
      name: metadata.name || file.name,
      parents: [folderId],
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
    form.append('file', file);

    const token = gapi.client.getToken();
    if (!token || !token.access_token) {
      throw new Error('Not authenticated. Please reconnect to Google Drive.');
    }

    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink,size,mimeType',
      {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + token.access_token }),
        body: form,
      }
    );

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error?.message || 'Upload failed');
    }

    return await response.json();
  },

  // List files in year folder
  async listFiles(year) {
    try {
      if (!gapi.client.drive) {
        console.error('Drive API not available');
        return [];
      }

      const folderId = await this.getYearFolderId(year);
      
      const response = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        fields: 'files(id, name, webViewLink, webContentLink, size, mimeType, createdTime, iconLink)',
        orderBy: 'createdTime desc',
      });

      return response.result.files || [];
    } catch (error) {
      console.error('Error listing files:', error);
      return [];
    }
  },

  // Delete file
  async deleteFile(fileId) {
    if (!gapi.client.drive) {
      throw new Error('Drive API not loaded');
    }
    await gapi.client.drive.files.delete({
      fileId: fileId,
    });
  },

  // Get storage quota
  async getStorageQuota() {
    if (!gapi.client.drive) {
      throw new Error('Drive API not loaded');
    }
    const response = await gapi.client.drive.about.get({
      fields: 'storageQuota',
    });
    return response.result.storageQuota;
  },

  // Download file
  downloadFile(webContentLink, fileName) {
    const link = document.createElement('a');
    link.href = webContentLink + '&export=download';
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};


    const { useState, useEffect, useMemo } = React;

    // Notes Modal Component  
    function NotesModal({ isOpen, onClose, onSave, initialNote, title }) {
      const [note, setNote] = useState(initialNote || '');

      useEffect(() => {
        setNote(initialNote || '');
      }, [initialNote, isOpen]);

      if (!isOpen) return null;

      return (
        <div className="notes-modal" onClick={onClose}>
          <div className="notes-modal-content" onClick={(e) => e.stopPropagation()}>
            <h3>{title}</h3>
            <textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              placeholder="Enter notes here..."
            />
            <div className="notes-modal-buttons">
              <button className="modal-button cancel" onClick={onClose}>
                Cancel
              </button>
              <button className="modal-button save" onClick={() => {
                onSave(note);
                onClose();
              }}>
                Save Note
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Utility functions
    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: 'CAD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amount || 0);
    };

    const MONTHS = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    const EXPENSE_CATEGORIES = [
      { name: 'Hydro (BC Hydro)', frequency: 'bimonthly', months: ['February', 'April', 'June', 'August', 'October', 'December'] },
      { name: 'City Utilities (Water/Sewer/Garbage)', frequency: 'semiannual', months: ['April', 'October'] },
      { name: 'Strata Insurance', frequency: 'annual', months: ['June'] },
      { name: 'Repairs & Maintenance', frequency: 'monthly', months: MONTHS }
    ];

    // Initialize default data structure
    const initializeData = (year) => ({
      strataFees: MONTHS.reduce((acc, month) => ({
        ...acc,
        [month]: { unit700: 0, unit702: 0, unit704: 0, unit706: 0 }
      }), {}),
      expenses: EXPENSE_CATEGORIES.reduce((acc, category) => ({
        ...acc,
        [category.name]: MONTHS.reduce((monthAcc, month) => ({
          ...monthAcc,
          [month]: 0
        }), {})
      }), {}),
      customExpenses: [], // Array of {name: string, frequency: string, months: array}
      crfBaseline: 0, // Starting CRF balance for this year
      insurance: {
        company: '',
        policyNumber: '',
        annualPremium: 0,
        coverageStart: '',
        coverageEnd: '',
        buildingCoverage: 0,
        liabilityCoverage: 0,
        deductible: 0
      },
      feeNotes: {}, // {month: note}
      expenseNotes: {}, // {categoryName-month: note}
      documents: [], // {id, name, date, notes, file (base64), year, isPermanent}
      permanentDocuments: [] // {id, name, date, notes, file (base64), year} - visible across all years
    });

    // Simple Bar Chart Component
    function SimpleBarChart({ data, dataKey, height = 300 }) {
      const maxValue = Math.max(...data.map(d => d[dataKey] || 0));
      
      return (
        <div style={{ height: height + 'px', display: 'flex', alignItems: 'flex-end', gap: '8px', padding: '40px 20px 30px' }}>
          {data.map((item, idx) => {
            const value = item[dataKey] || 0;
            const heightPercent = maxValue > 0 ? (value / maxValue) * 100 : 0;
            
            return (
              <div key={idx} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', position: 'relative' }}>
                <div style={{ 
                  width: '100%', 
                  height: (height - 70) + 'px',
                  display: 'flex',
                  alignItems: 'flex-end',
                  justifyContent: 'center'
                }}>
                  <div 
                    className="chart-bar"
                    style={{ 
                      width: '100%',
                      height: heightPercent + '%',
                      minHeight: value > 0 ? '20px' : '0'
                    }}
                    title={formatCurrency(value)}
                  >
                    {value > 0 && (
                      <div className="chart-value">{formatCurrency(value)}</div>
                    )}
                  </div>
                </div>
                <div className="chart-label" style={{ marginTop: '10px' }}>
                  {item.month || item.category || ''}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // Horizontal Bar Chart
    function HorizontalBarChart({ data }) {
      const maxValue = Math.max(...data.map(d => d.amount || 0));
      
      return (
        <div className="bar-chart-container">
          {data.map((item, idx) => {
            const widthPercent = maxValue > 0 ? (item.amount / maxValue) * 100 : 0;
            
            return (
              <div key={idx} className="bar-chart-item">
                <div className="bar-chart-label">{item.category}</div>
                <div className="bar-chart-bar-container">
                  <div 
                    className="bar-chart-bar-fill" 
                    style={{ width: widthPercent + '%' }}
                  />
                </div>
                <div className="bar-chart-value">{formatCurrency(item.amount)}</div>
              </div>
            );
          })}
        </div>
      );
    }

    // Main App Component
    function StrataApp() {
      const currentYear = new Date().getFullYear();
      const [selectedYear, setSelectedYear] = useState(currentYear);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [data, setData] = useState(() => {
        const stored = localStorage.getItem(`strata-data-${currentYear}`);
        return stored ? JSON.parse(stored) : initializeData(currentYear);
      });

      // Load data for selected year
      useEffect(() => {
        const stored = localStorage.getItem(`strata-data-${selectedYear}`);
        setData(stored ? JSON.parse(stored) : initializeData(selectedYear));
      }, [selectedYear]);

      // Save data whenever it changes
      useEffect(() => {
        localStorage.setItem(`strata-data-${selectedYear}`, JSON.stringify(data));
      }, [data, selectedYear]);

      // Get available years from localStorage plus current year
      const yearOptions = useMemo(() => {
        const years = new Set();
        const currentYear = new Date().getFullYear();
        
        // Add current year
        years.add(currentYear);
        
        // Scan localStorage for existing years
        for (let key in localStorage) {
          if (key.startsWith('strata-data-')) {
            const year = parseInt(key.replace('strata-data-', ''));
            if (!isNaN(year)) {
              years.add(year);
            }
          }
        }
        
        return Array.from(years).sort((a, b) => b - a); // Newest first
      }, [data]); // Re-calculate when data changes

      const addNewYear = () => {
        const yearInput = prompt('Enter year to add (e.g., 2027):');
        if (!yearInput) return;
        
        const newYear = parseInt(yearInput);
        if (isNaN(newYear) || newYear < 2000 || newYear > 2100) {
          alert('Please enter a valid year between 2000 and 2100');
          return;
        }
        
        if (yearOptions.includes(newYear)) {
          alert(`Year ${newYear} already exists`);
          setSelectedYear(newYear);
          return;
        }
        
        // Create initial data for new year
        const newYearData = initializeData(newYear);
        localStorage.setItem(`strata-data-${newYear}`, JSON.stringify(newYearData));
        
        // Switch to new year
        setSelectedYear(newYear);
        setData(newYearData);
      };

      // Calculate totals
      const totals = useMemo(() => {
        let totalIncome = 0;
        let totalExpenses = 0;

        // Calculate income from strata fees
        Object.values(data.strataFees).forEach(month => {
          totalIncome += (month.unit700 || 0) + (month.unit702 || 0) + (month.unit704 || 0) + (month.unit706 || 0);
        });

        // Calculate expenses
        Object.values(data.expenses).forEach(category => {
          Object.values(category).forEach(amount => {
            totalExpenses += amount || 0;
          });
        });

        return {
          income: totalIncome,
          expenses: totalExpenses,
          surplus: totalIncome - totalExpenses
        };
      }, [data]);

      const updateStrataFees = (month, unit, value) => {
        setData(prev => ({
          ...prev,
          strataFees: {
            ...prev.strataFees,
            [month]: {
              ...prev.strataFees[month],
              [unit]: parseFloat(value) || 0
            }
          }
        }));
      };
      // Attach setData for notes management
      updateStrataFees.__setData = setData;

      const updateExpense = (category, month, value) => {
        setData(prev => ({
          ...prev,
          expenses: {
            ...prev.expenses,
            [category]: {
              ...prev.expenses[category],
              [month]: parseFloat(value) || 0
            }
          }
        }));
      };
      // Attach setData for custom category management
      updateExpense.__setData = setData;

      const exportToPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yPos = 20;
        
        // Title
        doc.setFontSize(18);
        doc.text('Strata Financial Report', 20, yPos);
        yPos += 8;
        doc.setFontSize(10);
        doc.text('700 Block, Wilson Street, Victoria, BC - Strata Plan VIS4478', 20, yPos);
        yPos += 6;
        doc.setFontSize(12);
        doc.text(`Year: ${selectedYear}`, 20, yPos);
        yPos += 15;
        
        // Summary Section
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Financial Summary', 20, yPos);
        yPos += 8;
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(`Total Strata Fees: ${formatCurrency(totals.income)}`, 30, yPos);
        yPos += 6;
        doc.text(`Total Expenses: ${formatCurrency(totals.expenses)}`, 30, yPos);
        yPos += 6;
        doc.text(`Net Surplus/(Deficit): ${formatCurrency(totals.surplus)}`, 30, yPos);
        yPos += 6;
        doc.text(`CRF Opening Balance: ${formatCurrency(data.crfBaseline || 0)}`, 30, yPos);
        yPos += 6;
        doc.text(`CRF Projected Closing: ${formatCurrency((data.crfBaseline || 0) + totals.surplus)}`, 30, yPos);
        yPos += 15;

        // Strata Fees Section
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Strata Fees by Unit', 20, yPos);
        yPos += 8;
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        MONTHS.forEach(month => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          const fees = data.strataFees[month];
          const total = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
          if (total > 0) {
            doc.text(`${month}: 700=${formatCurrency(fees.unit700)} 702=${formatCurrency(fees.unit702)} 704=${formatCurrency(fees.unit704)} 706=${formatCurrency(fees.unit706)} Total=${formatCurrency(total)}`, 30, yPos);
            yPos += 5;
          }
        });

        yPos += 10;

        // Expenses Section
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Expenses by Category', 20, yPos);
        yPos += 8;
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');

        const allCategories = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])];
        allCategories.forEach(category => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          const total = Object.values(data.expenses[category.name] || {}).reduce((sum, val) => sum + (val || 0), 0);
          if (total > 0) {
            doc.text(`${category.name}: ${formatCurrency(total)}`, 30, yPos);
            yPos += 5;
          }
        });

        doc.save(`strata-report-${selectedYear}.pdf`);
      };

      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        // Summary sheet
        const summaryData = [
          ['Strata Financial Summary', selectedYear],
          ['700 Block, Wilson Street, Victoria, BC'],
          ['Strata Plan VIS4478'],
          [],
          ['Total Strata Fees', totals.income],
          ['Total Expenses', totals.expenses],
          ['Net Surplus/(Deficit)', totals.surplus],
          [],
          ['CRF Opening Balance', data.crfBaseline || 0],
          ['This Year Surplus', totals.surplus],
          ['CRF Projected Closing', (data.crfBaseline || 0) + totals.surplus]
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

        // Strata Fees sheet
        const feesData = [['Month', 'Unit 700', 'Unit 702', 'Unit 704', 'Unit 706', 'Total', 'Notes']];
        MONTHS.forEach(month => {
          const fees = data.strataFees[month];
          const total = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
          const notes = data.feeNotes?.[month] || '';
          feesData.push([month, fees.unit700, fees.unit702, fees.unit704, fees.unit706, total, notes]);
        });
        const ws2 = XLSX.utils.aoa_to_sheet(feesData);
        XLSX.utils.book_append_sheet(wb, ws2, 'Strata Fees');

        // Expenses sheet
        const expensesHeader = ['Category', 'Frequency', ...MONTHS, 'Total', 'Notes'];
        const expensesData = [expensesHeader];
        const allCategories = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])];
        allCategories.forEach(category => {
          const row = [category.name, category.frequency];
          let rowTotal = 0;
          MONTHS.forEach(month => {
            const amount = data.expenses[category.name]?.[month] || 0;
            row.push(amount);
            rowTotal += amount;
          });
          row.push(rowTotal);
          row.push(data.expenseNotes?.[category.name] || '');
          expensesData.push(row);
        });
        const ws3 = XLSX.utils.aoa_to_sheet(expensesData);
        XLSX.utils.book_append_sheet(wb, ws3, 'Expenses');

        // Insurance sheet
        const insuranceData = [
          ['Insurance Information', ''],
          ['Company', data.insurance.company],
          ['Policy Number', data.insurance.policyNumber],
          ['Coverage Start', data.insurance.coverageStart],
          ['Coverage End', data.insurance.coverageEnd],
          ['Annual Premium', data.insurance.annualPremium],
          ['Building Coverage', data.insurance.buildingCoverage],
          ['Liability Coverage', data.insurance.liabilityCoverage],
          ['Deductible', data.insurance.deductible]
        ];
        const ws4 = XLSX.utils.aoa_to_sheet(insuranceData);
        XLSX.utils.book_append_sheet(wb, ws4, 'Insurance');

        XLSX.writeFile(wb, `strata-data-${selectedYear}.xlsx`);
      };

      return (
        <div>
          <header className="header">
            <div className="header-content">
              <h1>Strata Management</h1>
              <p className="header-subtitle">4-Unit Strata ‚Ä¢ 700 Block, Wilson Street, Victoria, BC</p>
              <p className="header-subtitle" style={{ fontSize: '0.95rem', marginTop: '5px' }}>Strata Plan VIS4478</p>
            </div>
          </header>

          <div className="controls-bar">
            <div className="year-selector">
              <label>Year:</label>
              <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))}>
                {yearOptions.map(year => (
                  <option key={year} value={year}>{year}</option>
                ))}
              </select>
              <button 
                onClick={addNewYear}
                className="add-button"
                style={{ padding: '10px 15px', fontSize: '0.9rem' }}
                title="Add a new year"
              >
                + Add Year
              </button>
            </div>

            <nav className="nav-tabs">
              <button 
                className={`tab-button ${activeTab === 'dashboard' ? 'active' : ''}`}
                onClick={() => setActiveTab('dashboard')}
              >
                Dashboard
              </button>
              <button 
                className={`tab-button ${activeTab === 'fees' ? 'active' : ''}`}
                onClick={() => setActiveTab('fees')}
              >
                Strata Fees
              </button>
              <button 
                className={`tab-button ${activeTab === 'expenses' ? 'active' : ''}`}
                onClick={() => setActiveTab('expenses')}
              >
                Expenses
              </button>
              <button 
                className={`tab-button ${activeTab === 'insurance' ? 'active' : ''}`}
                onClick={() => setActiveTab('insurance')}
              >
                Insurance
              </button>
              <button 
                className={`tab-button ${activeTab === 'documents' ? 'active' : ''}`}
                onClick={() => setActiveTab('documents')}
              >
                Documents
              </button>
            </nav>

            <div className="export-buttons">
              <button className="export-button pdf" onClick={exportToPDF}>
                üìÑ Export PDF
              </button>
              <button className="export-button excel" onClick={exportToExcel}>
                üìä Export Excel
              </button>
            </div>
          </div>

          {activeTab === 'dashboard' && (
            <Dashboard data={data} totals={totals} selectedYear={selectedYear} setData={setData} />
          )}

          {activeTab === 'fees' && (
            <StrataFeesTab data={data} updateStrataFees={updateStrataFees} />
          )}

          {activeTab === 'expenses' && (
            <ExpensesTab data={data} updateExpense={updateExpense} />
          )}

          {activeTab === 'insurance' && (
            <InsuranceTab data={data} setData={setData} />
          )}

          {activeTab === 'documents' && (
            <DocumentsTab data={data} setData={setData} selectedYear={selectedYear} />
          )}
        </div>
      );
    }

    // Dashboard Component
    function Dashboard({ data, totals, selectedYear, setData }) {
      const chartData = MONTHS.map(month => {
        const fees = data.strataFees[month];
        const income = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
        
        let expenses = 0;
        Object.values(data.expenses).forEach(category => {
          expenses += category[month] || 0;
        });

        return {
          month: month.substring(0, 3),
          income,
          expenses,
          net: income - expenses
        };
      });

      const expenseBreakdown = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])].map(category => {
        let total = 0;
        Object.values(data.expenses[category.name] || {}).forEach(amount => {
          total += amount || 0;
        });
        return {
          category: category.name.replace(' (BC Hydro)', '').replace(' (Water/Sewer/Garbage)', ''),
          amount: total
        };
      }).filter(item => item.amount > 0);

      return (
        <>
          <div className="dashboard-grid">
            <div className="stat-card">
              <div className="stat-label">Total Strata Fees</div>
              <div className="stat-value">{formatCurrency(totals.income)}</div>
              <div className="stat-change positive">‚Üë Fees collected</div>
            </div>

            <div className="stat-card accent">
              <div className="stat-label">Total Expenses</div>
              <div className="stat-value">{formatCurrency(totals.expenses)}</div>
              <div className="stat-change">YTD spending</div>
            </div>

            <div className={`stat-card ${totals.surplus >= 0 ? 'success' : 'warning'}`}>
              <div className="stat-label">Net Surplus</div>
              <div className="stat-value">{formatCurrency(totals.surplus)}</div>
              <div className={`stat-change ${totals.surplus >= 0 ? 'positive' : 'negative'}`}>
                {totals.surplus >= 0 ? '‚Üë' : '‚Üì'} {totals.surplus >= 0 ? 'Surplus' : 'Deficit'}
              </div>
            </div>

            <div className="stat-card">
              <div className="stat-label">CRF Balance</div>
              <div className="stat-value">{formatCurrency((data.crfBaseline || 0) + totals.surplus)}</div>
              <div className="stat-change">Reserve fund</div>
            </div>
          </div>

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Contingency Reserve Fund (CRF)</h2>
            </div>
            <div style={{ padding: '20px' }}>
              <div className="form-row">
                <div className="form-group">
                  <label>CRF Opening Balance (Start of {selectedYear})</label>
                  <input
                    type="number"
                    step="0.01"
                    className="input-field"
                    value={data.crfBaseline || ''}
                    onChange={(e) => {
                      const value = parseFloat(e.target.value) || 0;
                      setData(prev => ({ ...prev, crfBaseline: value }));
                    }}
                    placeholder="0.00"
                    style={{ fontSize: '1.1rem', fontWeight: '600' }}
                  />
                  <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px' }}>
                    Enter the total CRF balance at the start of this year
                  </small>
                </div>
              </div>
              
              <div style={{ marginTop: '20px', padding: '20px', background: '#F0F9FF', borderRadius: '12px', border: '2px solid #BFDBFE' }}>
                <h3 style={{ color: 'var(--primary)', marginBottom: '15px' }}>CRF Calculation</h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>
                  <div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Opening Balance</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700' }}>{formatCurrency(data.crfBaseline || 0)}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>This Year's Surplus</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: totals.surplus >= 0 ? 'var(--success)' : 'var(--danger)' }}>
                      {formatCurrency(totals.surplus)}
                    </div>
                  </div>
                  <div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Projected Closing Balance</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: 'var(--primary)' }}>
                      {formatCurrency((data.crfBaseline || 0) + totals.surplus)}
                    </div>
                  </div>
                </div>
                <div style={{ marginTop: '15px', padding: '12px', background: 'white', borderRadius: '8px', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                  üí° <strong>Tip:</strong> At year-end, copy the "Projected Closing Balance" and paste it as next year's "Opening Balance" to maintain continuity.
                </div>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Annual Overview - Fees vs Expenses</h2>
            </div>
            <div style={{ padding: '40px 20px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-around', alignItems: 'flex-end', height: '300px', gap: '40px' }}>
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                  <div style={{ 
                    width: '100%',
                    maxWidth: '200px',
                    height: `${totals.income > 0 ? Math.min((totals.income / Math.max(totals.income, totals.expenses)) * 100, 100) : 0}%`,
                    minHeight: totals.income > 0 ? '40px' : '0',
                    background: 'linear-gradient(180deg, var(--success) 0%, #059669 100%)',
                    borderRadius: '8px 8px 0 0',
                    display: 'flex',
                    alignItems: 'flex-start',
                    justifyContent: 'center',
                    paddingTop: '10px',
                    transition: 'all 0.5s ease'
                  }}>
                    <strong style={{ color: 'white', fontSize: '1.2rem' }}>{formatCurrency(totals.income)}</strong>
                  </div>
                  <div style={{ marginTop: '15px', fontSize: '1.1rem', fontWeight: '600', color: 'var(--text-primary)' }}>
                    Total Fees
                  </div>
                </div>
                
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                  <div style={{ 
                    width: '100%',
                    maxWidth: '200px',
                    height: `${totals.expenses > 0 ? Math.min((totals.expenses / Math.max(totals.income, totals.expenses)) * 100, 100) : 0}%`,
                    minHeight: totals.expenses > 0 ? '40px' : '0',
                    background: 'linear-gradient(180deg, var(--danger) 0%, #dc2626 100%)',
                    borderRadius: '8px 8px 0 0',
                    display: 'flex',
                    alignItems: 'flex-start',
                    justifyContent: 'center',
                    paddingTop: '10px',
                    transition: 'all 0.5s ease'
                  }}>
                    <strong style={{ color: 'white', fontSize: '1.2rem' }}>{formatCurrency(totals.expenses)}</strong>
                  </div>
                  <div style={{ marginTop: '15px', fontSize: '1.1rem', fontWeight: '600', color: 'var(--text-primary)' }}>
                    Total Expenses
                  </div>
                </div>
              </div>
            </div>
          </div>

          {expenseBreakdown.length > 0 && (
            <div className="card">
              <div className="card-header">
                <h2 className="card-title">Expense Breakdown</h2>
              </div>
              <HorizontalBarChart data={expenseBreakdown} />
            </div>
          )}
        </>
      );
    }

    // Strata Fees Tab
    function StrataFeesTab({ data, updateStrataFees }) {
      const [notesModal, setNotesModal] = useState({ isOpen: false, month: null, note: '' });

      const saveNote = (note) => {
        updateStrataFees.__setData(prev => ({
          ...prev,
          feeNotes: {
            ...prev.feeNotes,
            [notesModal.month]: note
          }
        }));
      };

      return (
        <>
          <NotesModal
            isOpen={notesModal.isOpen}
            onClose={() => setNotesModal({ isOpen: false, month: null, note: '' })}
            onSave={saveNote}
            initialNote={notesModal.note}
            title={`Notes for ${notesModal.month}`}
          />

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Monthly Strata Fees - All Units</h2>
            </div>

            <div className="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Unit 700</th>
                    <th>Unit 702</th>
                    <th>Unit 704</th>
                    <th>Unit 706</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  {MONTHS.map(month => {
                    const fees = data.strataFees[month];
                    const total = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
                    
                    return (
                      <tr key={month}>
                        <td><strong>{month}</strong></td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit700 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit700', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`700-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `700-${month}`,
                              note: data.feeNotes?.[`700-${month}`] || ''
                            })}
                            title="Note for Unit 700"
                          >
                            üìù
                          </button>
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit702 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit702', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`702-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `702-${month}`,
                              note: data.feeNotes?.[`702-${month}`] || ''
                            })}
                            title="Note for Unit 702"
                          >
                            üìù
                          </button>
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit704 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit704', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`704-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `704-${month}`,
                              note: data.feeNotes?.[`704-${month}`] || ''
                            })}
                            title="Note for Unit 704"
                          >
                            üìù
                          </button>
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit706 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit706', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`706-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `706-${month}`,
                              note: data.feeNotes?.[`706-${month}`] || ''
                            })}
                            title="Note for Unit 706"
                          >
                            üìù
                          </button>
                        </td>
                        <td>
                          <strong>{formatCurrency(total)}</strong>
                        </td>
                      </tr>
                    );
                  })}
                  <tr className="total-row">
                    <td>TOTAL</td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit700 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit702 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit704 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit706 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => {
                            const fees = data.strataFees[month];
                            return sum + (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
                          }, 0)
                        )}
                      </strong>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </>
      );
    }

    // Expenses Tab
    function ExpensesTab({ data, updateExpense }) {
      const [newCategoryName, setNewCategoryName] = useState('');
      const [newCategoryFrequency, setNewCategoryFrequency] = useState('onetime');
      const [notesModal, setNotesModal] = useState({ isOpen: false, key: null, note: '' });

      const getFrequencyBadge = (frequency) => {
        const badges = {
          'onetime': { text: 'One-Time', class: 'danger' },
          'monthly': { text: 'Monthly', class: 'success' },
          'bimonthly': { text: 'Bi-Monthly', class: 'warning' },
          'semiannual': { text: 'Semi-Annual', class: 'warning' },
          'annual': { text: 'Annual', class: 'danger' }
        };
        return badges[frequency] || badges['monthly'];
      };

      const getMonthsForFrequency = (frequency) => {
        switch(frequency) {
          case 'onetime':
            return MONTHS; // Allow any month for one-time
          case 'bimonthly':
            return ['February', 'April', 'June', 'August', 'October', 'December'];
          case 'semiannual':
            return ['April', 'October'];
          case 'annual':
            return ['June'];
          default:
            return MONTHS;
        }
      };

      const addCustomCategory = (e, setData) => {
        e.preventDefault();
        if (!newCategoryName.trim()) return;

        const months = getMonthsForFrequency(newCategoryFrequency);
        const newCategory = {
          name: newCategoryName.trim(),
          frequency: newCategoryFrequency,
          months: months
        };

        setData(prev => {
          // Initialize expense data for this category
          const newExpenses = { ...prev.expenses };
          newExpenses[newCategory.name] = MONTHS.reduce((acc, month) => ({
            ...acc,
            [month]: 0
          }), {});

          return {
            ...prev,
            customExpenses: [...(prev.customExpenses || []), newCategory],
            expenses: newExpenses
          };
        });

        setNewCategoryName('');
        setNewCategoryFrequency('onetime');
      };

      const deleteCustomCategory = (categoryName, setData) => {
        if (!confirm(`Delete "${categoryName}"? This will remove all data for this category.`)) return;

        setData(prev => {
          const newExpenses = { ...prev.expenses };
          delete newExpenses[categoryName];

          return {
            ...prev,
            customExpenses: (prev.customExpenses || []).filter(cat => cat.name !== categoryName),
            expenses: newExpenses
          };
        });
      };

      const saveNote = (note) => {
        updateExpense.__setData(prev => ({
          ...prev,
          expenseNotes: {
            ...prev.expenseNotes,
            [notesModal.key]: note
          }
        }));
      };

      // Combine default and custom categories
      const allCategories = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])];

      return (
        <>
          <NotesModal
            isOpen={notesModal.isOpen}
            onClose={() => setNotesModal({ isOpen: false, key: null, note: '' })}
            onSave={saveNote}
            initialNote={notesModal.note}
            title={`Notes for expense`}
          />

          <div className="card">
          <div className="card-header">
            <h2 className="card-title">Monthly Expenses by Category</h2>
          </div>

          <div className="table-container" style={{ overflowX: 'auto' }}>
            <table style={{ tableLayout: 'auto', width: '100%', minWidth: '800px' }}>
              <thead>
                <tr>
                  <th style={{ minWidth: '90px', width: '90px' }}>Month</th>
                  {allCategories.map(category => {
                    const displayName = category.name
                      .replace('(BC Hydro)', '<br/><span style="font-size: 0.7rem;">(BC Hydro)</span>')
                      .replace('(Water/Sewer/Garbage)', '<br/><span style="font-size: 0.65rem;">(Water/Sewer/Garbage)</span>');
                    
                    return (
                      <th key={category.name} style={{ 
                        minWidth: '140px',
                        maxWidth: '180px',
                        whiteSpace: 'normal',
                        wordWrap: 'break-word',
                        padding: '10px 5px'
                      }}>
                        <div dangerouslySetInnerHTML={{ __html: displayName }} style={{ 
                          wordWrap: 'break-word',
                          overflowWrap: 'break-word'
                        }} />
                        <br />
                        <span className={`badge ${getFrequencyBadge(category.frequency).class}`} style={{ fontSize: '0.6rem' }}>
                          {getFrequencyBadge(category.frequency).text}
                        </span>
                      </th>
                    );
                  })}
                  <th style={{ minWidth: '100px', width: '100px' }}>Total</th>
                </tr>
              </thead>
              <tbody>
                {MONTHS.map(month => {
                  let monthTotal = 0;
                  
                  return (
                    <tr key={month}>
                      <td><strong>{month}</strong></td>
                      {allCategories.map(category => {
                        const value = data.expenses[category.name]?.[month] || 0;
                        monthTotal += value;
                        const noteKey = `${category.name}-${month}`;
                        const hasNote = data.expenseNotes && data.expenseNotes[noteKey];
                        
                        return (
                          <td key={category.name}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px', alignItems: 'center' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '2px', width: '100%', justifyContent: 'center' }}>
                                <input
                                  type="number"
                                  step="0.01"
                                  className="input-field"
                                  value={value || ''}
                                  onChange={(e) => updateExpense(category.name, month, e.target.value)}
                                  placeholder="0.00"
                                  style={{ width: '85px', flex: '1', minWidth: '70px', maxWidth: '100px' }}
                                />
                                <button
                                  className={`notes-button ${hasNote ? 'has-note' : ''}`}
                                  onClick={() => setNotesModal({
                                    isOpen: true,
                                    key: noteKey,
                                    note: data.expenseNotes?.[noteKey] || ''
                                  })}
                                  title={hasNote ? 'Edit note' : 'Add note'}
                                >
                                  üìù
                                </button>
                              </div>
                            </div>
                          </td>
                        );
                      })}
                      <td>
                        <strong>{formatCurrency(monthTotal)}</strong>
                      </td>
                    </tr>
                  );
                })}
                <tr className="total-row">
                  <td>TOTAL</td>
                  {allCategories.map(category => {
                    const categoryTotal = Object.values(data.expenses[category.name] || {}).reduce((sum, val) => sum + (val || 0), 0);
                    const isCustom = !EXPENSE_CATEGORIES.find(cat => cat.name === category.name);
                    
                    return (
                      <td key={category.name}>
                        <strong>{formatCurrency(categoryTotal)}</strong>
                        {isCustom && (
                          <button 
                            className="delete-button"
                            onClick={() => deleteCustomCategory(category.name, updateExpense.__setData)}
                            style={{ marginLeft: '4px', fontSize: '0.7rem', padding: '2px 4px' }}
                          >
                            ‚úï
                          </button>
                        )}
                      </td>
                    );
                  })}
                  <td>
                    <strong>
                      {formatCurrency(
                        allCategories.reduce((total, category) => {
                          return total + Object.values(data.expenses[category.name] || {}).reduce((sum, val) => sum + (val || 0), 0);
                        }, 0)
                      )}
                    </strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div className="add-category-section">
            <h3 style={{ marginBottom: '15px', color: 'var(--primary)', fontSize: '1.1rem' }}>
              ‚ûï Add Custom Expense Category
            </h3>
            <form className="add-category-form" onSubmit={(e) => addCustomCategory(e, updateExpense.__setData)}>
              <div className="form-group">
                <label>Category Name</label>
                <input
                  type="text"
                  className="input-field"
                  value={newCategoryName}
                  onChange={(e) => setNewCategoryName(e.target.value)}
                  placeholder="e.g., Elevator Maintenance"
                />
              </div>
              <div className="form-group">
                <label>Billing Frequency</label>
                <select
                  className="input-field"
                  value={newCategoryFrequency}
                  onChange={(e) => setNewCategoryFrequency(e.target.value)}
                >
                  <option value="onetime">One-Time</option>
                  <option value="monthly">Monthly</option>
                  <option value="bimonthly">Bi-Monthly</option>
                  <option value="semiannual">Semi-Annual</option>
                  <option value="annual">Annual</option>
                </select>
              </div>
              <button type="submit" className="add-button">
                + Add Category
              </button>
            </form>
          </div>

          <div style={{ marginTop: '20px', padding: '15px', background: '#F0F9FF', borderRadius: '8px', border: '1px solid #BFDBFE' }}>
            <strong style={{ color: '#1E40AF' }}>üí° Billing Schedule:</strong>
            <ul style={{ marginTop: '10px', marginLeft: '20px', color: '#1E3A8A' }}>
              <li><strong>Hydro:</strong> Billed every 2 months (Feb, Apr, Jun, Aug, Oct, Dec)</li>
              <li><strong>City Utilities:</strong> Combined water/sewer/garbage bill twice yearly (April & October)</li>
              <li><strong>Other expenses:</strong> Enter as they occur</li>
            </ul>
          </div>
        </div>
        </>
      );
    }

    // Insurance Tab
    function InsuranceTab({ data, setData }) {
      const updateInsurance = (field, value) => {
        setData(prev => ({
          ...prev,
          insurance: {
            ...prev.insurance,
            [field]: value
          }
        }));
      };

      return (
        <div className="card">
          <div className="card-header">
            <h2 className="card-title">Strata Insurance Details</h2>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Insurance Company</label>
              <input
                type="text"
                className="input-field"
                value={data.insurance.company || ''}
                onChange={(e) => updateInsurance('company', e.target.value)}
                placeholder="Company name"
              />
            </div>

            <div className="form-group">
              <label>Policy Number</label>
              <input
                type="text"
                className="input-field"
                value={data.insurance.policyNumber || ''}
                onChange={(e) => updateInsurance('policyNumber', e.target.value)}
                placeholder="Policy #"
              />
            </div>

            <div className="form-group">
              <label>Broker/Agent Name</label>
              <input
                type="text"
                className="input-field"
                value={data.insurance.brokerName || ''}
                onChange={(e) => updateInsurance('brokerName', e.target.value)}
                placeholder="Broker name"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Broker Contact Phone</label>
              <input
                type="tel"
                className="input-field"
                value={data.insurance.brokerPhone || ''}
                onChange={(e) => updateInsurance('brokerPhone', e.target.value)}
                placeholder="(250) 555-1234"
              />
            </div>

            <div className="form-group">
              <label>Broker Email</label>
              <input
                type="email"
                className="input-field"
                value={data.insurance.brokerEmail || ''}
                onChange={(e) => updateInsurance('brokerEmail', e.target.value)}
                placeholder="broker@insurance.com"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Coverage Start Date</label>
              <input
                type="date"
                className="input-field"
                value={data.insurance.coverageStart || ''}
                onChange={(e) => updateInsurance('coverageStart', e.target.value)}
              />
            </div>

            <div className="form-group">
              <label>Coverage End Date</label>
              <input
                type="date"
                className="input-field"
                value={data.insurance.coverageEnd || ''}
                onChange={(e) => updateInsurance('coverageEnd', e.target.value)}
              />
            </div>

            <div className="form-group">
              <label>Renewal Date</label>
              <input
                type="date"
                className="input-field"
                value={data.insurance.renewalDate || ''}
                onChange={(e) => updateInsurance('renewalDate', e.target.value)}
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Annual Premium</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.annualPremium || ''}
                onChange={(e) => updateInsurance('annualPremium', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Building Replacement Value</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.buildingCoverage || ''}
                onChange={(e) => updateInsurance('buildingCoverage', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Contents Coverage (Common Areas)</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.contentsCoverage || ''}
                onChange={(e) => updateInsurance('contentsCoverage', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Liability Coverage</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.liabilityCoverage || ''}
                onChange={(e) => updateInsurance('liabilityCoverage', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Deductible (All Perils)</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.deductible || ''}
                onChange={(e) => updateInsurance('deductible', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Earthquake Deductible</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.earthquakeDeductible || ''}
                onChange={(e) => updateInsurance('earthquakeDeductible', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Water Damage Deductible</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.waterDeductible || ''}
                onChange={(e) => updateInsurance('waterDeductible', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Sewer Backup Coverage</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.sewerBackup || ''}
                onChange={(e) => updateInsurance('sewerBackup', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
          </div>

          <div className="form-group">
            <label>Additional Coverage Notes</label>
            <textarea
              className="input-field"
              value={data.insurance.notes || ''}
              onChange={(e) => updateInsurance('notes', e.target.value)}
              placeholder="E.g., Directors & Officers insurance, equipment breakdown, flood coverage, etc."
              style={{ minHeight: '100px', resize: 'vertical' }}
            />
          </div>

          <div style={{ marginTop: '30px', padding: '20px', background: 'var(--bg-main)', borderRadius: '12px' }}>
            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>Insurance Summary</h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '15px' }}>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Annual Premium</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.annualPremium)}
                </div>
              </div>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Building Coverage</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.buildingCoverage)}
                </div>
              </div>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Liability Coverage</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.liabilityCoverage)}
                </div>
              </div>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Standard Deductible</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.deductible)}
                </div>
              </div>
            </div>
            {data.insurance.renewalDate && (
              <div style={{ marginTop: '15px', padding: '12px', background: '#FFF7ED', borderRadius: '8px', border: '1px solid #FDBA74' }}>
                <strong style={{ color: '#C2410C' }}>üìÖ Next Renewal:</strong>{' '}
                <span style={{ color: '#9A3412' }}>
                  {new Date(data.insurance.renewalDate).toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' })}
                </span>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Documents Tab
    // Documents Tab with Google Drive Integration
    function DocumentsTab({ data, setData, selectedYear }) {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [isUploading, setIsUploading] = useState(false);
      const [driveFiles, setDriveFiles] = useState([]);
      const [permanentFiles, setPermanentFiles] = useState([]);
      const [storageQuota, setStorageQuota] = useState(null);
      const [sortBy, setSortBy] = useState('date');
      const [showUploadModal, setShowUploadModal] = useState(false);
      const [selectedFile, setSelectedFile] = useState(null);
      const [uploadForm, setUploadForm] = useState({ name: '', date: '', isPermanent: false });

      // Check authentication status
      useEffect(() => {
        setIsAuthenticated(GoogleDriveManager.isAuthenticated());
      }, []);

      // Load files when authenticated
      useEffect(() => {
        if (isAuthenticated) {
          loadFiles();
          loadStorageQuota();
        }
      }, [isAuthenticated, selectedYear]);

      const loadFiles = async () => {
        try {
          const files = await GoogleDriveManager.listFiles(selectedYear);
          setDriveFiles(files);
          
          // Load permanent records from local storage
          const permStr = localStorage.getItem('strata-permanent-documents');
          if (permStr) {
            const permDocs = JSON.parse(permStr);
            setPermanentFiles(permDocs);
          }
        } catch (error) {
          console.error('Error loading files:', error);
          alert('Error loading files. You may need to reconnect to Google Drive.');
        }
      };

      const loadStorageQuota = async () => {
        try {
          const quota = await GoogleDriveManager.getStorageQuota();
          setStorageQuota(quota);
        } catch (error) {
          console.error('Error loading quota:', error);
        }
      };

      const handleAuthenticate = async () => {
        try {
          await GoogleDriveManager.authenticate();
          setIsAuthenticated(true);
          alert('‚úÖ Connected to Google Drive!');
        } catch (error) {
          console.error('Auth error:', error);
          alert('Failed to connect to Google Drive. Please try again.');
        }
      };

      const handleSignOut = () => {
        GoogleDriveManager.signOut();
        setIsAuthenticated(false);
        setDriveFiles([]);
      };

      const handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        setSelectedFile(file);
        setUploadForm({
          name: file.name.replace(/\.[^/.]+$/, ''),
          date: new Date().toISOString().split('T')[0],
          isPermanent: false
        });
        setShowUploadModal(true);
        event.target.value = '';
      };

      const handleUploadSubmit = async () => {
        if (!uploadForm.name || !uploadForm.date) {
          alert('Please fill in all required fields');
          return;
        }

        setIsUploading(true);
        try {
          const result = await GoogleDriveManager.uploadFile(selectedFile, selectedYear, {
            name: uploadForm.name,
            date: uploadForm.date
          });

          if (uploadForm.isPermanent) {
            const permDoc = {
              id: result.id,
              name: uploadForm.name,
              date: uploadForm.date,
              year: selectedYear,
              driveFileId: result.id,
              webViewLink: result.webViewLink
            };

            const permStr = localStorage.getItem('strata-permanent-documents');
            const permDocs = permStr ? JSON.parse(permStr) : [];
            permDocs.push(permDoc);
            localStorage.setItem('strata-permanent-documents', JSON.stringify(permDocs));
            setPermanentFiles(permDocs);
          }

          alert('‚úÖ File uploaded successfully!');
          await loadFiles();
          setShowUploadModal(false);
          setSelectedFile(null);
          setUploadForm({ name: '', date: '', isPermanent: false });
        } catch (error) {
          console.error('Upload error:', error);
          alert('‚ùå Upload failed: ' + error.message);
        } finally {
          setIsUploading(false);
        }
      };

      const handleDelete = async (fileId, isPerm) => {
        if (!confirm('Delete this document?')) return;

        try {
          await GoogleDriveManager.deleteFile(fileId);

          if (isPerm) {
            const permStr = localStorage.getItem('strata-permanent-documents');
            const permDocs = permStr ? JSON.parse(permStr) : [];
            const updated = permDocs.filter(doc => doc.driveFileId !== fileId);
            localStorage.setItem('strata-permanent-documents', JSON.stringify(updated));
            setPermanentFiles(updated);
          }

          await loadFiles();
          alert('‚úÖ Document deleted');
        } catch (error) {
          console.error('Delete error:', error);
          alert('‚ùå Delete failed: ' + error.message);
        }
      };

      const formatBytes = (bytes) => {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
      };

      if (!isAuthenticated) {
        return (
          <div className="card">
            <div className="card-header">
              <h2 className="card-title">üìÅ Document Management</h2>
            </div>
            <div style={{ padding: '60px 20px', textAlign: 'center' }}>
              <div style={{ fontSize: '4rem', marginBottom: '20px' }}>‚òÅÔ∏è</div>
              <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>Connect to Google Drive</h3>
              <p style={{ marginBottom: '30px', color: 'var(--text-secondary)', maxWidth: '500px', margin: '0 auto 30px' }}>
                Upload, view, and download strata documents stored in Google Drive (15 GB free storage)
              </p>
              <button onClick={handleAuthenticate} className="add-button" style={{ padding: '15px 40px', fontSize: '1.1rem' }}>
                üîó Connect to Google Drive
              </button>
              <div style={{ marginTop: '30px', padding: '20px', background: '#F0F9FF', borderRadius: '12px', maxWidth: '600px', margin: '30px auto 0' }}>
                <p style={{ fontSize: '0.9rem', color: '#075985', lineHeight: '1.6' }}>
                  <strong>üìå First time setup:</strong><br/>
                  Click the button above and sign in with: <strong>stratavis4478@gmail.com</strong><br/>
                  You'll only need to do this once per browser.
                </p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <>
          {showUploadModal && (
            <div className="upload-modal" onClick={() => setShowUploadModal(false)}>
              <div className="upload-modal-content" onClick={(e) => e.stopPropagation()}>
                <h3>Upload Document</h3>
                <div className="form-group">
                  <label>Document Name <span style={{ color: 'var(--danger)' }}>*</span></label>
                  <input
                    type="text"
                    className="input-field"
                    value={uploadForm.name}
                    onChange={(e) => setUploadForm({...uploadForm, name: e.target.value})}
                    placeholder="e.g., AGM Minutes 2025"
                  />
                </div>
                <div className="form-group">
                  <label>Date <span style={{ color: 'var(--danger)' }}>*</span></label>
                  <input
                    type="date"
                    className="input-field"
                    value={uploadForm.date}
                    onChange={(e) => setUploadForm({...uploadForm, date: e.target.value})}
                  />
                  <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px', fontStyle: 'italic' }}>
                    If day is unknown, use the 1st of the month
                  </small>
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={uploadForm.isPermanent}
                      onChange={(e) => setUploadForm({...uploadForm, isPermanent: e.target.checked})}
                      style={{ width: '18px', height: '18px' }}
                    />
                    <span>‚≠ê Keep as Permanent Record</span>
                  </label>
                  <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px', marginLeft: '26px', fontStyle: 'italic' }}>
                    Document will be visible in all years
                  </small>
                </div>
                <div className="upload-modal-buttons">
                  <button className="modal-button cancel" onClick={() => setShowUploadModal(false)}>
                    Cancel
                  </button>
                  <button className="modal-button save" onClick={handleUploadSubmit} disabled={isUploading}>
                    {isUploading ? '‚è≥ Uploading...' : 'üíæ Upload'}
                  </button>
                </div>
              </div>
            </div>
          )}

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Upload Document for {selectedYear}</h2>
              <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                {storageQuota && (
                  <>
                    <span style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Drive Storage:</span>
                    <div style={{ width: '200px', height: '20px', background: '#E5E7EB', borderRadius: '10px', overflow: 'hidden' }}>
                      <div style={{
                        width: `${(storageQuota.usage / storageQuota.limit) * 100}%`,
                        height: '100%',
                        background: 'var(--success)',
                        transition: 'width 0.3s'
                      }}></div>
                    </div>
                    <span style={{ fontSize: '0.85rem', fontWeight: '600' }}>
                      {formatBytes(storageQuota.usage)} / {formatBytes(storageQuota.limit)}
                    </span>
                  </>
                )}
                <button onClick={handleSignOut} className="export-button pdf" style={{ fontSize: '0.85rem' }}>
                  Sign Out
                </button>
              </div>
            </div>
            <div style={{ padding: '20px' }}>
              <div style={{ padding: '30px', border: '2px dashed #BFDBFE', borderRadius: '12px', textAlign: 'center', background: '#F0F9FF' }}>
                <div style={{ fontSize: '3rem', marginBottom: '15px' }}>üì§</div>
                <h3 style={{ marginBottom: '10px', color: 'var(--primary)' }}>Upload Document</h3>
                <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>
                  Select a file to upload to Google Drive
                </p>
                <input
                  type="file"
                  onChange={handleFileSelect}
                  style={{ display: 'none' }}
                  id="file-upload"
                  accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                  disabled={isUploading}
                />
                <label htmlFor="file-upload" className="add-button" style={{ cursor: isUploading ? 'wait' : 'pointer', display: 'inline-block' }}>
                  {isUploading ? '‚è≥ Uploading...' : 'üìé Choose File'}
                </label>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Documents for {selectedYear}</h2>
            </div>
            {driveFiles.length === 0 ? (
              <div className="empty-state">
                <h3>No documents yet</h3>
                <p>Upload documents using the button above</p>
              </div>
            ) : (
              <div className="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Document Name</th>
                      <th>Size</th>
                      <th>Uploaded</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {driveFiles.map(file => (
                      <tr key={file.id}>
                        <td><strong>{file.name}</strong></td>
                        <td>{formatBytes(file.size)}</td>
                        <td>{new Date(file.createdTime).toLocaleDateString()}</td>
                        <td>
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <a
                              href={file.webViewLink}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="notes-button"
                              style={{ borderColor: 'var(--primary)', color: 'var(--primary)', textDecoration: 'none', display: 'inline-block' }}
                            >
                              üëÅ View
                            </a>
                            <a
                              href={file.webContentLink}
                              target="_blank"
                              className="notes-button"
                              style={{ borderColor: 'var(--success)', color: 'var(--success)', textDecoration: 'none', display: 'inline-block' }}
                            >
                              ‚¨á Download
                            </a>
                            <button
                              className="delete-button"
                              onClick={() => handleDelete(file.id, false)}
                            >
                              ‚úï
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {permanentFiles.length > 0 && (
            <div className="card">
              <div className="card-header">
                <h2 className="card-title">üìö Permanent Records</h2>
              </div>
              <div style={{ padding: '15px', background: '#FFF7ED', borderRadius: '8px', margin: '20px', border: '2px solid #FDBA74' }}>
                <strong style={{ color: '#C2410C' }}>üìå Permanent Archive</strong>
                <p style={{ marginTop: '8px', color: '#9A3412', fontSize: '0.9rem' }}>
                  Documents marked as permanent records are viewable across all years.
                </p>
              </div>
              <div className="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Document Name</th>
                      <th>Year</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {permanentFiles.map(doc => (
                      <tr key={doc.id}>
                        <td><strong>{doc.name}</strong></td>
                        <td><span className="badge success">{doc.year}</span></td>
                        <td>{new Date(doc.date).toLocaleDateString()}</td>
                        <td>
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <a
                              href={doc.webViewLink}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="notes-button"
                              style={{ borderColor: 'var(--primary)', color: 'var(--primary)', textDecoration: 'none', display: 'inline-block' }}
                            >
                              üëÅ View
                            </a>
                            <button
                              className="delete-button"
                              onClick={() => handleDelete(doc.driveFileId, true)}
                            >
                              ‚úï
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </>
      );
    }


    // Render the app
    ReactDOM.render(<StrataApp />, document.getElementById('root'));
  </script>
</body>
</html>
