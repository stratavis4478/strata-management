<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strata Management Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.1.9/dist/Recharts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <script>
    // Google Drive API Configuration - YOUR CREDENTIALS
    const GOOGLE_CONFIG = {
      apiKey: 'AIzaSyAlhSQp5ZgYJFFBTao9E9pHx57lZvAeBmw',
      clientId: '968897213704-rdjoe3d05fvft9uei1jdl61uto5k6cug.apps.googleusercontent.com',
      appId: '968897213704',
      scope: 'https://www.googleapis.com/auth/drive.file',
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      strataFolderName: 'Strata VIS4478'
    };

    let gapiReady = false;
    let driveApiReady = false;
    let oauthToken;
    
    // Load and initialize Google API
    async function initGoogleAPI() {
      console.log('ðŸ”„ Starting Google API initialization...');
      
      // Wait for gapi to be available
      let attempts = 0;
      while (typeof gapi === 'undefined' && attempts < 20) {
        await new Promise(resolve => setTimeout(resolve, 500));
        attempts++;
      }
      
      if (typeof gapi === 'undefined') {
        console.error('âŒ gapi failed to load');
        return;
      }
      
      console.log('âœ… gapi loaded');
      
      // Load client library
      return new Promise((resolve) => {
        gapi.load('client', async () => {
          try {
            console.log('ðŸ”„ Initializing gapi.client...');
            
            await gapi.client.init({
              apiKey: GOOGLE_CONFIG.apiKey,
              discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
            });
            
            console.log('âœ… gapi.client initialized');
            
            // Load Drive API explicitly
            await gapi.client.load('drive', 'v3');
            
            console.log('âœ… Drive API v3 loaded');
            
            // Verify drive is available
            if (gapi.client.drive) {
              driveApiReady = true;
              gapiReady = true;
              console.log('âœ…âœ… Google Drive API fully ready!');
            } else {
              console.error('âŒ Drive API loaded but not accessible');
            }
            
            resolve();
          } catch (error) {
            console.error('âŒ Error initializing Google API:', error);
            resolve(); // Resolve anyway so app loads
          }
        });
      });
    }
    
    // Auto-start initialization
    window.addEventListener('load', () => {
      initGoogleAPI();
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2B4C7E;
      --primary-dark: #1E3557;
      --accent: #D97D54;
      --accent-light: #F4A261;
      --bg-main: #F8F9FA;
      --bg-card: #FFFFFF;
      --text-primary: #1A1A1A;
      --text-secondary: #6B7280;
      --border: #E5E7EB;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    #root {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .header-content {
      position: relative;
      z-index: 1;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }

    .header-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      font-family: 'Space Mono', monospace;
    }

    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .year-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .year-selector label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .year-selector select {
      padding: 10px 15px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Space Mono', monospace;
    }

    .year-selector select:hover {
      border-color: var(--primary);
    }

    .year-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 76, 126, 0.1);
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      background: var(--bg-card);
      padding: 10px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .tab-button {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .tab-button:hover {
      background: var(--bg-main);
      color: var(--text-primary);
    }

    .tab-button.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .export-buttons {
      display: flex;
      gap: 10px;
    }

    .export-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'DM Sans', sans-serif;
    }

    .export-button.pdf {
      background: var(--danger);
      color: white;
    }

    .export-button.excel {
      background: var(--success);
      color: white;
    }

    .export-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s;
      border-left: 4px solid var(--primary);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.accent {
      border-left-color: var(--accent);
    }

    .stat-card.success {
      border-left-color: var(--success);
    }

    .stat-card.warning {
      border-left-color: var(--warning);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.02em;
    }

    .stat-change {
      font-size: 0.9rem;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow-md);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .add-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .add-button:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
    }

    .add-category-section {
      margin-top: 20px;
      padding: 20px;
      background: #F0F9FF;
      border-radius: 12px;
      border: 2px dashed #BFDBFE;
    }

    .add-category-form {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .add-category-form .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 150px;
    }

    .delete-button {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
    }

    .delete-button:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    th:first-child {
      border-top-left-radius: 10px;
    }

    th:last-child {
      border-top-right-radius: 10px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: var(--bg-main);
    }

    .input-field {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.2s;
      min-width: 100px;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 76, 126, 0.1);
    }

    .input-field::-webkit-inner-spin-button,
    .input-field::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .notes-button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      vertical-align: super;
      margin-left: 4px;
      display: inline-block;
    }

    .notes-button:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(43, 76, 126, 0.05);
    }

    .notes-button.has-note {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .input-with-note {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .notes-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .notes-modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }

    .notes-modal h3 {
      margin-bottom: 15px;
      color: var(--primary);
    }

    .notes-modal textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      resize: vertical;
    }

    .notes-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }

    .modal-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .modal-button.save {
      background: var(--success);
      color: white;
    }

    .modal-button.cancel {
      background: var(--border);
      color: var(--text-primary);
    }

    .upload-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .upload-modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }

    .upload-modal h3 {
      margin-bottom: 20px;
      color: var(--primary);
    }

    .upload-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .total-row {
      font-weight: 700;
      background: linear-gradient(135deg, #F0F4F8 0%, #E2E8F0 100%);
      font-family: 'Space Mono', monospace;
    }

    .total-row td {
      border-bottom: 3px solid var(--primary);
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .month-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      border-top: 3px solid var(--accent);
    }

    .month-card h4 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .unit-input {
      margin-bottom: 12px;
    }

    .unit-input label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-weight: 600;
    }

    .chart-container {
      margin-top: 30px;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
    }

    .simple-chart {
      width: 100%;
      height: 300px;
      position: relative;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .chart-bar {
      flex: 1;
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
      transition: all 0.3s;
    }

    .chart-bar:hover {
      opacity: 0.8;
    }

    .chart-bar.income {
      background: linear-gradient(180deg, var(--success) 0%, #059669 100%);
    }

    .chart-bar.expense {
      background: linear-gradient(180deg, var(--danger) 0%, #dc2626 100%);
    }

    .chart-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .chart-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .badge.warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .nav-tabs {
        flex-wrap: wrap;
      }

      .export-buttons {
        width: 100%;
        flex-direction: column;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .stat-value {
        font-size: 2rem;
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .bar-chart-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .bar-chart-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bar-chart-label {
      width: 150px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .bar-chart-bar-container {
      flex: 1;
      height: 30px;
      background: #e5e7eb;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .bar-chart-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .bar-chart-value {
      min-width: 80px;
      text-align: right;
      font-family: 'Space Mono', monospace;
      font-weight: 600;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Google Drive Integration Module
const GoogleDriveManager = {
  // Initialize and authenticate
  async authenticate() {
    console.log('ðŸ” Starting authentication...');
    console.log('driveApiReady:', driveApiReady);
    console.log('gapi.client.drive:', !!gapi?.client?.drive);
    
    return new Promise((resolve, reject) => {
      // Check if API is ready
      if (!driveApiReady || !gapi?.client?.drive) {
        console.error('âŒ Drive API not ready');
        reject(new Error('Google Drive API is not ready yet. Please wait 5 seconds and try again.'));
        return;
      }

      console.log('âœ… Drive API ready, requesting token...');

      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CONFIG.clientId,
        scope: GOOGLE_CONFIG.scope,
        callback: (response) => {
          if (response.error) {
            console.error('âŒ Auth error:', response);
            reject(response);
            return;
          }
          oauthToken = response.access_token;
          gapi.client.setToken({ access_token: oauthToken });
          
          // Save token to localStorage PERMANENTLY (no expiry)
          localStorage.setItem('google-drive-token', oauthToken);
          
          console.log('âœ… Authentication successful!');
          resolve(response);
        },
      });
      
      tokenClient.requestAccessToken({ prompt: 'consent' });
    });
  },

  // Check if authenticated and token is still valid
  async isAuthenticated() {
    // Check if we have a stored token
    const storedToken = localStorage.getItem('google-drive-token');
    
    if (storedToken) {
      // Token exists - restore it
      if (!oauthToken) {
        oauthToken = storedToken;
        if (gapi?.client) {
          gapi.client.setToken({ access_token: oauthToken });
        }
      }
      
      // Validate token by making a test API call
      try {
        if (gapi?.client?.drive) {
          await gapi.client.drive.about.get({ fields: 'user' });
          return true; // Token is valid
        }
      } catch (error) {
        // Token is expired or invalid
        console.warn('Token expired, clearing...');
        localStorage.removeItem('google-drive-token');
        oauthToken = null;
        if (gapi?.client) {
          gapi.client.setToken(null);
        }
        return false;
      }
    }
    
    return !!oauthToken && !!gapi?.client?.getToken();
  },

  // Sign out
  signOut() {
    if (oauthToken) {
      google.accounts.oauth2.revoke(oauthToken);
      gapi.client.setToken(null);
      oauthToken = null;
      localStorage.removeItem('google-drive-token');
    }
  },

  // Find or create folder
  async findOrCreateFolder(folderName, parentFolderId = null) {
    try {
      if (!gapi.client.drive) {
        throw new Error('Drive API not loaded. Please refresh and reconnect.');
      }

      let query = `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
      if (parentFolderId) {
        query += ` and '${parentFolderId}' in parents`;
      }

      const response = await gapi.client.drive.files.list({
        q: query,
        fields: 'files(id, name)',
      });

      if (response.result.files && response.result.files.length > 0) {
        return response.result.files[0].id;
      }

      // Create folder
      const folderMetadata = {
        name: folderName,
        mimeType: 'application/vnd.google-apps.folder',
      };
      if (parentFolderId) {
        folderMetadata.parents = [parentFolderId];
      }

      const folder = await gapi.client.drive.files.create({
        resource: folderMetadata,
        fields: 'id',
      });

      return folder.result.id;
    } catch (error) {
      this.handleApiError(error);
    }
  },

  // Get year folder ID
  async getYearFolderId(year) {
    const strataFolderId = await this.findOrCreateFolder(GOOGLE_CONFIG.strataFolderName);
    const yearFolderId = await this.findOrCreateFolder(year.toString(), strataFolderId);
    return yearFolderId;
  },

  // Upload file
  async uploadFile(file, year, metadata) {
    const folderId = await this.getYearFolderId(year);
    
    const fileMetadata = {
      name: metadata.name || file.name,
      parents: [folderId],
      description: metadata.date || '' // Store custom date in description
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
    form.append('file', file);

    const token = gapi.client.getToken();
    if (!token || !token.access_token) {
      throw new Error('Not authenticated. Please reconnect to Google Drive.');
    }

    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink,size,mimeType',
      {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + token.access_token }),
        body: form,
      }
    );

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error?.message || 'Upload failed');
    }

    return await response.json();
  },

  // List files in year folder
  async listFiles(year) {
    try {
      if (!gapi.client.drive) {
        console.error('Drive API not available');
        return [];
      }

      const folderId = await this.getYearFolderId(year);
      
      const response = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        fields: 'files(id, name, webViewLink, webContentLink, size, mimeType, createdTime, description, iconLink)',
        orderBy: 'createdTime desc',
      });

      return response.result.files || [];
    } catch (error) {
      console.error('Error listing files:', error);
      return [];
    }
  },

  // Delete file
  async deleteFile(fileId) {
    if (!gapi.client.drive) {
      throw new Error('Drive API not loaded');
    }
    await gapi.client.drive.files.delete({
      fileId: fileId,
    });
  },

  // Get storage quota
  async getStorageQuota() {
    if (!gapi.client.drive) {
      throw new Error('Drive API not loaded');
    }
    const response = await gapi.client.drive.about.get({
      fields: 'storageQuota',
    });
    return response.result.storageQuota;
  },

  // Download file
  downloadFile(webContentLink, fileName) {
    const link = document.createElement('a');
    link.href = webContentLink + '&export=download';
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  },

  // Handle API errors (especially 401 unauthorized)
  handleApiError(error) {
    if (error?.result?.error?.code === 401 || error?.status === 401) {
      // Token expired
      localStorage.removeItem('google-drive-token');
      oauthToken = null;
      if (gapi?.client) {
        gapi.client.setToken(null);
      }
      throw new Error('Your session expired. Please reconnect to Google Drive.');
    }
    throw error;
  }
};

// Simple Cloud Storage Manager
const SimpleCloudStorage = {
  dataFileName: 'strata-data-all-years.json',
  strataFolderId: null,
  dataFileId: null,

  async initialize() {
    console.log('â˜ï¸ Initializing cloud storage...');
    this.strataFolderId = await GoogleDriveManager.findOrCreateFolder(GOOGLE_CONFIG.strataFolderName);
    
    // Find or create data file
    const response = await gapi.client.drive.files.list({
      q: `name='${this.dataFileName}' and '${this.strataFolderId}' in parents and trashed=false`,
      fields: 'files(id, name)',
    });

    if (response.result.files && response.result.files.length > 0) {
      this.dataFileId = response.result.files[0].id;
      console.log('âœ… Found existing data file');
    } else {
      // Create new file
      console.log('ðŸ“ Creating new data file');
      const fileMetadata = {
        name: this.dataFileName,
        mimeType: 'application/json',
        parents: [this.strataFolderId]
      };

      const file = new Blob([JSON.stringify({}, null, 2)], { type: 'application/json' });
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
      form.append('file', file);

      const token = gapi.client.getToken();
      const uploadResponse = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
        {
          method: 'POST',
          headers: new Headers({ Authorization: 'Bearer ' + token.access_token }),
          body: form,
        }
      );

      const result = await uploadResponse.json();
      this.dataFileId = result.id;
      console.log('âœ… Created data file');
    }
    
    return true;
  },

  async loadAllData() {
    console.log('ðŸ“¥ Loading all data from Drive...');
    const response = await gapi.client.drive.files.get({
      fileId: this.dataFileId,
      alt: 'media'
    });
    console.log('âœ… Data loaded from Drive');
    return response.result || {};
  },

  async saveAllData(allData) {
    console.log('ðŸ’¾ Saving all data to Drive...');
    const fileContent = JSON.stringify(allData, null, 2);
    const file = new Blob([fileContent], { type: 'application/json' });
    const token = gapi.client.getToken();
    
    const response = await fetch(
      `https://www.googleapis.com/upload/drive/v3/files/${this.dataFileId}?uploadType=media`,
      {
        method: 'PATCH',
        headers: new Headers({ 
          Authorization: 'Bearer ' + token.access_token,
          'Content-Type': 'application/json'
        }),
        body: file,
      }
    );

    if (response.ok) {
      console.log('âœ… Data saved to Drive');
      return true;
    }
    throw new Error('Save failed');
  }
};


    const { useState, useEffect, useMemo } = React;

    // Notes Modal Component  
    function NotesModal({ isOpen, onClose, onSave, initialNote, title }) {
      const [note, setNote] = useState(initialNote || '');

      useEffect(() => {
        setNote(initialNote || '');
      }, [initialNote, isOpen]);

      if (!isOpen) return null;

      return (
        <div className="notes-modal" onClick={onClose}>
          <div className="notes-modal-content" onClick={(e) => e.stopPropagation()}>
            <h3>{title}</h3>
            <textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              placeholder="Enter notes here..."
            />
            <div className="notes-modal-buttons">
              <button className="modal-button cancel" onClick={onClose}>
                Cancel
              </button>
              <button className="modal-button save" onClick={() => {
                onSave(note);
                onClose();
              }}>
                Save Note
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Utility functions
    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: 'CAD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amount || 0);
    };

    const MONTHS = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    const EXPENSE_CATEGORIES = [
      { name: 'Hydro (BC Hydro)', frequency: 'bimonthly', months: ['February', 'April', 'June', 'August', 'October', 'December'] },
      { name: 'City Utilities (Water/Sewer/Garbage)', frequency: 'semiannual', months: ['April', 'October'] },
      { name: 'Strata Insurance', frequency: 'annual', months: ['June'] }
    ];

    // Initialize default data structure
    const initializeData = (year) => ({
      strataFees: MONTHS.reduce((acc, month) => ({
        ...acc,
        [month]: { unit700: 0, unit702: 0, unit704: 0, unit706: 0 }
      }), {}),
      expenses: EXPENSE_CATEGORIES.reduce((acc, category) => ({
        ...acc,
        [category.name]: MONTHS.reduce((monthAcc, month) => ({
          ...monthAcc,
          [month]: 0
        }), {})
      }), {}),
      customExpenses: [], // Array of {name: string, frequency: string, months: array}
      crfBaseline: 0, // Starting CRF balance for this year
      insurance: {
        company: '',
        policyNumber: '',
        annualPremium: 0,
        coverageStart: '',
        coverageEnd: '',
        buildingCoverage: 0,
        liabilityCoverage: 0,
        deductible: 0
      },
      feeNotes: {}, // {month: note}
      expenseNotes: {}, // {categoryName-month: note}
      documents: [], // {id, name, date, notes, file (base64), year, isPermanent}
      permanentDocuments: [] // {id, name, date, notes, file (base64), year} - visible across all years
    });

    // Simple Bar Chart Component
    function SimpleBarChart({ data, dataKey, height = 300 }) {
      const maxValue = Math.max(...data.map(d => d[dataKey] || 0));
      
      return (
        <div style={{ height: height + 'px', display: 'flex', alignItems: 'flex-end', gap: '8px', padding: '40px 20px 30px' }}>
          {data.map((item, idx) => {
            const value = item[dataKey] || 0;
            const heightPercent = maxValue > 0 ? (value / maxValue) * 100 : 0;
            
            return (
              <div key={idx} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', position: 'relative' }}>
                <div style={{ 
                  width: '100%', 
                  height: (height - 70) + 'px',
                  display: 'flex',
                  alignItems: 'flex-end',
                  justifyContent: 'center'
                }}>
                  <div 
                    className="chart-bar"
                    style={{ 
                      width: '100%',
                      height: heightPercent + '%',
                      minHeight: value > 0 ? '20px' : '0'
                    }}
                    title={formatCurrency(value)}
                  >
                    {value > 0 && (
                      <div className="chart-value">{formatCurrency(value)}</div>
                    )}
                  </div>
                </div>
                <div className="chart-label" style={{ marginTop: '10px' }}>
                  {item.month || item.category || ''}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // Horizontal Bar Chart
    function HorizontalBarChart({ data }) {
      const maxValue = Math.max(...data.map(d => d.amount || 0));
      
      return (
        <div className="bar-chart-container">
          {data.map((item, idx) => {
            const widthPercent = maxValue > 0 ? (item.amount / maxValue) * 100 : 0;
            
            return (
              <div key={idx} className="bar-chart-item">
                <div className="bar-chart-label">{item.category}</div>
                <div className="bar-chart-bar-container">
                  <div 
                    className="bar-chart-bar-fill" 
                    style={{ width: widthPercent + '%' }}
                  />
                </div>
                <div className="bar-chart-value">{formatCurrency(item.amount)}</div>
              </div>
            );
          })}
        </div>
      );
    }

    // Main App Component
    function StrataApp() {
      const currentYear = new Date().getFullYear();
      const [selectedYear, setSelectedYear] = useState(currentYear);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [allYearsData, setAllYearsData] = useState(null); // null = loading
      const [cloudReady, setCloudReady] = useState(false);
      const [isAuthenticated, setIsAuthenticated] = useState(false);

      // Current year's data
      const data = allYearsData?.[selectedYear] || initializeData(selectedYear);
      
      // Permanent documents stored at root level
      const permanentDocuments = allYearsData?.permanentDocuments || [];

      // Check authentication and initialize cloud storage
      useEffect(() => {
        const checkAndInit = async () => {
          const isAuth = await GoogleDriveManager.isAuthenticated();
          setIsAuthenticated(isAuth);
          
          if (isAuth && !cloudReady) {
            try {
              await SimpleCloudStorage.initialize();
              const cloudData = await SimpleCloudStorage.loadAllData();
              
              // If no data in cloud but have localStorage, migrate it
              if (Object.keys(cloudData).length === 0) {
                const localData = {};
                for (let key in localStorage) {
                  if (key.startsWith('strata-data-')) {
                    const year = key.replace('strata-data-', '');
                    localData[year] = JSON.parse(localStorage.getItem(key));
                  }
                }
                
                if (Object.keys(localData).length > 0) {
                  console.log('ðŸ“¦ Migrating localStorage data to cloud...');
                  await SimpleCloudStorage.saveAllData(localData);
                  setAllYearsData(localData);
                } else {
                  // Start fresh with current year
                  const initial = { [currentYear]: initializeData(currentYear) };
                  setAllYearsData(initial);
                }
              } else {
                setAllYearsData(cloudData);
              }
              
              setCloudReady(true);
            } catch (error) {
              console.error('Cloud init error:', error);
              alert('Failed to connect to cloud storage. Using local storage as fallback.');
              // Fall back to localStorage
              const stored = localStorage.getItem(`strata-data-${currentYear}`);
              setAllYearsData({ [currentYear]: stored ? JSON.parse(stored) : initializeData(currentYear) });
            }
          }
        };
        
        checkAndInit();
      }, [isAuthenticated, cloudReady, currentYear]);

      // Save to cloud when data changes (debounced)
      useEffect(() => {
        if (!cloudReady || !allYearsData) return;
        
        const timer = setTimeout(async () => {
          try {
            await SimpleCloudStorage.saveAllData(allYearsData);
          } catch (error) {
            console.error('Save error:', error);
            // Fallback to localStorage
            localStorage.setItem(`strata-data-${selectedYear}`, JSON.stringify(data));
          }
        }, 1000);
        
        return () => clearTimeout(timer);
      }, [allYearsData, cloudReady]);

      // Update data when something changes
      const setData = (newData) => {
        setAllYearsData(prev => ({
          ...prev,
          [selectedYear]: typeof newData === 'function' ? newData(data) : newData
        }));
      };
      
      // Update permanent documents (stored at root level)
      const setPermanentDocuments = (newDocs) => {
        setAllYearsData(prev => ({
          ...prev,
          permanentDocuments: typeof newDocs === 'function' ? newDocs(permanentDocuments) : newDocs
        }));
      };

      // Get available years from cloud data
      const yearOptions = useMemo(() => {
        if (!allYearsData) return [currentYear];
        
        const years = new Set();
        years.add(currentYear);
        
        Object.keys(allYearsData).forEach(key => {
          // Only add valid year numbers, skip 'permanentDocuments' and other non-year keys
          const year = parseInt(key);
          if (!isNaN(year) && year >= 2000 && year <= 2100) {
            years.add(year);
          }
        });
        
        return Array.from(years).sort((a, b) => b - a);
      }, [allYearsData, currentYear]);

      const addNewYear = async () => {
        const yearInput = prompt('Enter year to add (e.g., 2027):');
        if (!yearInput) return;
        
        const newYear = parseInt(yearInput);
        if (isNaN(newYear) || newYear < 2000 || newYear > 2100) {
          alert('Please enter a valid year between 2000 and 2100');
          return;
        }
        
        if (yearOptions.includes(newYear)) {
          alert(`Year ${newYear} already exists`);
          setSelectedYear(newYear);
          return;
        }
        
        // Create initial data for new year
        const newYearData = initializeData(newYear);
        setAllYearsData(prev => ({
          ...prev,
          [newYear]: newYearData
        }));
        
        // Switch to new year
        setSelectedYear(newYear);
      };

      // Calculate totals
      const totals = useMemo(() => {
        let totalIncome = 0;
        let totalExpenses = 0;

        // Calculate income from strata fees
        Object.values(data.strataFees).forEach(month => {
          totalIncome += (month.unit700 || 0) + (month.unit702 || 0) + (month.unit704 || 0) + (month.unit706 || 0);
        });

        // Calculate expenses
        Object.values(data.expenses).forEach(category => {
          Object.values(category).forEach(amount => {
            totalExpenses += amount || 0;
          });
        });

        return {
          income: totalIncome,
          expenses: totalExpenses,
          surplus: totalIncome - totalExpenses
        };
      }, [data]);

      const updateStrataFees = (month, unit, value) => {
        // Handle general notes field
        if (month === 'strataFeesNotes') {
          setData(prev => ({
            ...prev,
            strataFeesNotes: unit // value is passed as second param in this case
          }));
          return;
        }
        
        // Handle regular fee updates
        setData(prev => ({
          ...prev,
          strataFees: {
            ...prev.strataFees,
            [month]: {
              ...prev.strataFees[month],
              [unit]: parseFloat(value) || 0
            }
          }
        }));
      };
      // Attach setData for notes management
      updateStrataFees.__setData = setData;

      const updateExpense = (category, month, value) => {
        // Handle general notes field
        if (category === 'expensesTabNotes') {
          setData(prev => ({
            ...prev,
            expensesTabNotes: month // value is passed as second param
          }));
          return;
        }
        
        // Handle regular expense updates
        setData(prev => ({
          ...prev,
          expenses: {
            ...prev.expenses,
            [category]: {
              ...prev.expenses[category],
              [month]: parseFloat(value) || 0
            }
          }
        }));
      };
      // Attach setData for custom category management
      updateExpense.__setData = setData;

      const exportToPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yPos = 20;
        
        // Title Page
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('Strata Financial Report', 105, yPos, { align: 'center' });
        yPos += 10;
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('700 Block, Wilson Street, Victoria, BC', 105, yPos, { align: 'center' });
        yPos += 6;
        doc.text('Strata Plan VIS4478', 105, yPos, { align: 'center' });
        yPos += 6;
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text(`Year: ${selectedYear}`, 105, yPos, { align: 'center' });
        yPos += 20;
        
        // Financial Summary Box
        doc.setFillColor(240, 249, 255);
        doc.rect(15, yPos, 180, 55, 'F');
        yPos += 10;
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Financial Summary', 20, yPos);
        yPos += 8;
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(`Total Strata Fees:`, 25, yPos);
        doc.text(formatCurrency(totals.income), 170, yPos, { align: 'right' });
        yPos += 7;
        doc.text(`Total Expenses:`, 25, yPos);
        doc.text(formatCurrency(totals.expenses), 170, yPos, { align: 'right' });
        yPos += 7;
        doc.setFont(undefined, 'bold');
        if (totals.surplus >= 0) {
          doc.setTextColor(5, 150, 105); // Green
        } else {
          doc.setTextColor(220, 38, 38); // Red
        }
        doc.text(`Net Surplus/(Deficit):`, 25, yPos);
        doc.text(formatCurrency(totals.surplus), 170, yPos, { align: 'right' });
        doc.setTextColor(0, 0, 0);
        yPos += 7;
        doc.setFont(undefined, 'normal');
        doc.text(`CRF Opening Balance:`, 25, yPos);
        doc.text(formatCurrency(data.crfBaseline || 0), 170, yPos, { align: 'right' });
        yPos += 7;
        doc.text(`CRF Projected Closing:`, 25, yPos);
        doc.text(formatCurrency((data.crfBaseline || 0) + totals.surplus), 170, yPos, { align: 'right' });
        yPos += 20;

        // NEW PAGE - Strata Fees Table
        doc.addPage();
        yPos = 20;
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('Strata Fees by Month', 20, yPos);
        yPos += 10;
        
        // Table headers
        doc.setFontSize(10);
        doc.setFillColor(147, 197, 253);
        doc.rect(15, yPos - 5, 180, 8, 'F');
        doc.text('Month', 20, yPos);
        doc.text('Unit 700', 60, yPos, { align: 'right' });
        doc.text('Unit 702', 90, yPos, { align: 'right' });
        doc.text('Unit 704', 120, yPos, { align: 'right' });
        doc.text('Unit 706', 150, yPos, { align: 'right' });
        doc.text('Total', 180, yPos, { align: 'right' });
        yPos += 8;
        
        doc.setFont(undefined, 'normal');
        let feeGrandTotal = 0;
        MONTHS.forEach(month => {
          const fees = data.strataFees[month];
          const monthTotal = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
          feeGrandTotal += monthTotal;
          
          doc.text(month, 20, yPos);
          doc.text(formatCurrency(fees.unit700 || 0), 60, yPos, { align: 'right' });
          doc.text(formatCurrency(fees.unit702 || 0), 90, yPos, { align: 'right' });
          doc.text(formatCurrency(fees.unit704 || 0), 120, yPos, { align: 'right' });
          doc.text(formatCurrency(fees.unit706 || 0), 150, yPos, { align: 'right' });
          doc.text(formatCurrency(monthTotal), 180, yPos, { align: 'right' });
          yPos += 6;
        });
        
        // Total row
        doc.setFont(undefined, 'bold');
        doc.setFillColor(249, 250, 251);
        doc.rect(15, yPos - 3, 180, 8, 'F');
        doc.text('TOTAL', 20, yPos);
        doc.text(formatCurrency(feeGrandTotal), 180, yPos, { align: 'right' });
        
        // NEW PAGE - Expenses Table
        doc.addPage();
        yPos = 20;
        doc.setFont(undefined, 'bold');
        doc.setFontSize(16);
        doc.text('Expenses by Category', 20, yPos);
        yPos += 10;
        
        const allCategories = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])];
        doc.setFontSize(10);
        
        allCategories.forEach(category => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          
          // Category header
          doc.setFillColor(147, 197, 253);
          doc.rect(15, yPos - 5, 180, 7, 'F');
          doc.setFont(undefined, 'bold');
          doc.text(category.name, 20, yPos);
          yPos += 8;
          
          // Month totals
          doc.setFont(undefined, 'normal');
          let categoryTotal = 0;
          MONTHS.forEach(month => {
            const amount = data.expenses[category.name]?.[month] || 0;
            categoryTotal += amount;
            if (amount > 0) {
              doc.text(`  ${month}:`, 25, yPos);
              doc.text(formatCurrency(amount), 180, yPos, { align: 'right' });
              yPos += 5;
            }
          });
          
          // Category total
          doc.setFont(undefined, 'bold');
          doc.setFillColor(249, 250, 251);
          doc.rect(15, yPos - 2, 180, 6, 'F');
          doc.text(`${category.name} Total:`, 25, yPos);
          doc.text(formatCurrency(categoryTotal), 180, yPos, { align: 'right' });
          yPos += 10;
        });

        // Grand total for expenses
        if (yPos > 260) {
          doc.addPage();
          yPos = 20;
        }
        doc.setFillColor(59, 130, 246);
        doc.rect(15, yPos - 5, 180, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.text('TOTAL EXPENSES:', 25, yPos);
        doc.text(formatCurrency(totals.expenses), 180, yPos, { align: 'right' });
        doc.setTextColor(0, 0, 0);

        // NEW PAGE - Budget (if exists)
        if (data.budget?.currentYearProposed) {
          doc.addPage();
          yPos = 20;
          doc.setFontSize(16);
          doc.setFont(undefined, 'bold');
          doc.text(`${selectedYear} Budget Comparison`, 20, yPos);
          yPos += 10;
          
          // Get prior year data for budget
          const priorYear = selectedYear - 1;
          const priorYearData = allYearsData?.[priorYear];
          const priorYearProposedBudget = priorYearData?.budget?.currentYearProposed || { fees: {}, expenses: {} };
          
          // Calculate prior year actuals
          const priorYearActuals = { fees: {}, expenses: {} };
          if (priorYearData) {
            Object.values(priorYearData.strataFees || {}).forEach(month => {
              priorYearActuals.fees.unit700 = (priorYearActuals.fees.unit700 || 0) + (month.unit700 || 0);
              priorYearActuals.fees.unit702 = (priorYearActuals.fees.unit702 || 0) + (month.unit702 || 0);
              priorYearActuals.fees.unit704 = (priorYearActuals.fees.unit704 || 0) + (month.unit704 || 0);
              priorYearActuals.fees.unit706 = (priorYearActuals.fees.unit706 || 0) + (month.unit706 || 0);
            });
            
            if (priorYearData.expenses) {
              Object.entries(priorYearData.expenses).forEach(([category, monthlyData]) => {
                let categoryTotal = 0;
                if (monthlyData && typeof monthlyData === 'object') {
                  Object.values(monthlyData).forEach(amount => {
                    categoryTotal += (parseFloat(amount) || 0);
                  });
                }
                priorYearActuals.expenses[category] = categoryTotal;
              });
            }
          }
          
          // Budget table headers
          doc.setFontSize(9);
          doc.setFillColor(147, 197, 253);
          doc.rect(15, yPos - 4, 180, 7, 'F');
          doc.text('Line Item', 20, yPos);
          doc.text(`${priorYear} Budget`, 85, yPos, { align: 'right' });
          doc.text(`${priorYear} Actual`, 115, yPos, { align: 'right' });
          doc.text(`${selectedYear} Budget`, 180, yPos, { align: 'right' });
          yPos += 8;
          
          // Fees section
          doc.setFont(undefined, 'bold');
          doc.text('STRATA FEES', 20, yPos);
          yPos += 6;
          doc.setFont(undefined, 'normal');
          
          ['unit700', 'unit702', 'unit704', 'unit706'].forEach(unit => {
            const unitNum = unit.replace('unit', '');
            doc.text(`Unit ${unitNum}`, 25, yPos);
            doc.text(formatCurrency(priorYearProposedBudget.fees?.[unit] || 0), 85, yPos, { align: 'right' });
            doc.text(formatCurrency(priorYearActuals.fees?.[unit] || 0), 115, yPos, { align: 'right' });
            doc.text(formatCurrency(data.budget.currentYearProposed.fees?.[unit] || 0), 180, yPos, { align: 'right' });
            yPos += 5;
          });
          
          // Expenses section
          yPos += 5;
          doc.setFont(undefined, 'bold');
          doc.text('EXPENSES', 20, yPos);
          yPos += 6;
          doc.setFont(undefined, 'normal');
          
          const budgetCategories = ['Hydro (BC Hydro)', 'City Utilities (Water/Sewer/Garbage)', 'Strata Insurance', 'Repairs & Maintenance'];
          const priorYearCustomCats = priorYearData?.expenses ? Object.keys(priorYearData.expenses).filter(cat => !budgetCategories.includes(cat)) : [];
          const allBudgetCategories = [...budgetCategories, ...priorYearCustomCats];
          
          allBudgetCategories.forEach(category => {
            if (yPos > 275) {
              doc.addPage();
              yPos = 20;
            }
            const catName = category.length > 25 ? category.substring(0, 25) + '...' : category;
            doc.text(catName, 25, yPos);
            doc.text(formatCurrency(priorYearProposedBudget.expenses?.[category] || 0), 85, yPos, { align: 'right' });
            doc.text(formatCurrency(priorYearActuals.expenses?.[category] || 0), 115, yPos, { align: 'right' });
            doc.text(formatCurrency(data.budget.currentYearProposed.expenses?.[category] || 0), 180, yPos, { align: 'right' });
            yPos += 5;
          });
        }

        doc.save(`strata-report-${selectedYear}.pdf`);
      };

      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        // Summary sheet with totals
        const summaryData = [
          ['Strata Financial Summary', selectedYear],
          ['700 Block, Wilson Street, Victoria, BC'],
          ['Strata Plan VIS4478'],
          [],
          ['Total Strata Fees', totals.income],
          ['Total Expenses', totals.expenses],
          ['Net Surplus/(Deficit)', totals.surplus],
          [],
          ['CRF Opening Balance', data.crfBaseline || 0],
          ['This Year Surplus', totals.surplus],
          ['CRF Projected Closing', (data.crfBaseline || 0) + totals.surplus]
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
        ws1['!cols'] = [{ wch: 40 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

        // Strata Fees sheet with monthly totals and grand total
        const feesData = [['Month', 'Unit 700', 'Unit 702', 'Unit 704', 'Unit 706', 'Monthly Total']];
        let unit700Total = 0, unit702Total = 0, unit704Total = 0, unit706Total = 0, grandTotal = 0;
        
        MONTHS.forEach(month => {
          const fees = data.strataFees[month];
          const monthTotal = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
          unit700Total += fees.unit700 || 0;
          unit702Total += fees.unit702 || 0;
          unit704Total += fees.unit704 || 0;
          unit706Total += fees.unit706 || 0;
          grandTotal += monthTotal;
          feesData.push([month, fees.unit700 || 0, fees.unit702 || 0, fees.unit704 || 0, fees.unit706 || 0, monthTotal]);
        });
        
        // Add totals row
        feesData.push(['TOTAL', unit700Total, unit702Total, unit704Total, unit706Total, grandTotal]);
        
        const ws2 = XLSX.utils.aoa_to_sheet(feesData);
        ws2['!cols'] = [
          { wch: 15 },  // Month
          { wch: 12 },  // Unit 700
          { wch: 12 },  // Unit 702
          { wch: 12 },  // Unit 704
          { wch: 12 },  // Unit 706
          { wch: 15 }   // Total
        ];
        XLSX.utils.book_append_sheet(wb, ws2, 'Strata Fees');

        // Expenses sheet with monthly and category totals
        const expensesHeader = ['Month', ...EXPENSE_CATEGORIES.map(c => c.name), ...(data.customExpenses || []).map(c => c.name), 'Monthly Total'];
        const expensesData = [expensesHeader];
        
        const allCategories = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])];
        const categoryTotals = {};
        allCategories.forEach(cat => categoryTotals[cat.name] = 0);
        
        MONTHS.forEach(month => {
          const row = [month];
          let monthTotal = 0;
          
          allCategories.forEach(category => {
            const amount = data.expenses[category.name]?.[month] || 0;
            row.push(amount);
            monthTotal += amount;
            categoryTotals[category.name] += amount;
          });
          
          row.push(monthTotal);
          expensesData.push(row);
        });
        
        // Add totals row
        const totalsRow = ['TOTAL'];
        let expensesGrandTotal = 0;
        allCategories.forEach(category => {
          totalsRow.push(categoryTotals[category.name]);
          expensesGrandTotal += categoryTotals[category.name];
        });
        totalsRow.push(expensesGrandTotal);
        expensesData.push(totalsRow);
        
        const ws3 = XLSX.utils.aoa_to_sheet(expensesData);
        ws3['!cols'] = [
          { wch: 15 },  // Month
          ...allCategories.map(() => ({ wch: 18 })),  // Category columns
          { wch: 15 }   // Total
        ];
        XLSX.utils.book_append_sheet(wb, ws3, 'Expenses');

        // Budget sheet (if exists)
        if (data.budget?.currentYearProposed) {
          const priorYear = selectedYear - 1;
          const priorYearData = allYearsData?.[priorYear];
          const priorYearProposedBudget = priorYearData?.budget?.currentYearProposed || { fees: {}, expenses: {} };
          
          // Calculate prior year actuals
          const priorYearActuals = { fees: {}, expenses: {} };
          if (priorYearData) {
            Object.values(priorYearData.strataFees || {}).forEach(month => {
              priorYearActuals.fees.unit700 = (priorYearActuals.fees.unit700 || 0) + (month.unit700 || 0);
              priorYearActuals.fees.unit702 = (priorYearActuals.fees.unit702 || 0) + (month.unit702 || 0);
              priorYearActuals.fees.unit704 = (priorYearActuals.fees.unit704 || 0) + (month.unit704 || 0);
              priorYearActuals.fees.unit706 = (priorYearActuals.fees.unit706 || 0) + (month.unit706 || 0);
            });
            
            if (priorYearData.expenses) {
              Object.entries(priorYearData.expenses).forEach(([category, monthlyData]) => {
                let categoryTotal = 0;
                if (monthlyData && typeof monthlyData === 'object') {
                  Object.values(monthlyData).forEach(amount => {
                    categoryTotal += (parseFloat(amount) || 0);
                  });
                }
                priorYearActuals.expenses[category] = categoryTotal;
              });
            }
          }
          
          const budgetData = [
            [`${selectedYear} Budget Comparison`],
            [],
            ['Line Item', `${priorYear} Budget Proposed`, `${priorYear} Actual`, `${selectedYear} Budget Proposed`],
            [],
            ['STRATA FEES'],
            ['Unit 700', priorYearProposedBudget.fees?.unit700 || 0, priorYearActuals.fees?.unit700 || 0, data.budget.currentYearProposed.fees?.unit700 || 0],
            ['Unit 702', priorYearProposedBudget.fees?.unit702 || 0, priorYearActuals.fees?.unit702 || 0, data.budget.currentYearProposed.fees?.unit702 || 0],
            ['Unit 704', priorYearProposedBudget.fees?.unit704 || 0, priorYearActuals.fees?.unit704 || 0, data.budget.currentYearProposed.fees?.unit704 || 0],
            ['Unit 706', priorYearProposedBudget.fees?.unit706 || 0, priorYearActuals.fees?.unit706 || 0, data.budget.currentYearProposed.fees?.unit706 || 0],
            []
          ];
          
          // Calculate fee totals
          const priorBudgetFeesTotal = (priorYearProposedBudget.fees?.unit700 || 0) + (priorYearProposedBudget.fees?.unit702 || 0) + (priorYearProposedBudget.fees?.unit704 || 0) + (priorYearProposedBudget.fees?.unit706 || 0);
          const priorActualFeesTotal = (priorYearActuals.fees?.unit700 || 0) + (priorYearActuals.fees?.unit702 || 0) + (priorYearActuals.fees?.unit704 || 0) + (priorYearActuals.fees?.unit706 || 0);
          const currentBudgetFeesTotal = (data.budget.currentYearProposed.fees?.unit700 || 0) + (data.budget.currentYearProposed.fees?.unit702 || 0) + (data.budget.currentYearProposed.fees?.unit704 || 0) + (data.budget.currentYearProposed.fees?.unit706 || 0);
          
          budgetData.push(['TOTAL FEES', priorBudgetFeesTotal, priorActualFeesTotal, currentBudgetFeesTotal]);
          budgetData.push([]);
          budgetData.push(['EXPENSES']);
          
          // Add expense categories
          const budgetCategories = ['Hydro (BC Hydro)', 'City Utilities (Water/Sewer/Garbage)', 'Strata Insurance', 'Repairs & Maintenance'];
          const priorYearCustomCats = priorYearData?.expenses ? Object.keys(priorYearData.expenses).filter(cat => !budgetCategories.includes(cat)) : [];
          const allBudgetCategories = [...budgetCategories, ...priorYearCustomCats];
          
          let priorBudgetExpTotal = 0, priorActualExpTotal = 0, currentBudgetExpTotal = 0;
          
          allBudgetCategories.forEach(category => {
            const priorBudget = priorYearProposedBudget.expenses?.[category] || 0;
            const priorActual = priorYearActuals.expenses?.[category] || 0;
            const currentBudget = data.budget.currentYearProposed.expenses?.[category] || 0;
            
            priorBudgetExpTotal += priorBudget;
            priorActualExpTotal += priorActual;
            currentBudgetExpTotal += currentBudget;
            
            budgetData.push([category, priorBudget, priorActual, currentBudget]);
          });
          
          budgetData.push([]);
          budgetData.push(['TOTAL EXPENSES', priorBudgetExpTotal, priorActualExpTotal, currentBudgetExpTotal]);
          budgetData.push([]);
          budgetData.push(['SURPLUS / (DEFICIT)', priorBudgetFeesTotal - priorBudgetExpTotal, priorActualFeesTotal - priorActualExpTotal, currentBudgetFeesTotal - currentBudgetExpTotal]);
          
          const ws_budget = XLSX.utils.aoa_to_sheet(budgetData);
          ws_budget['!cols'] = [
            { wch: 40 },  // Line Item
            { wch: 20 },  // Prior Budget
            { wch: 20 },  // Prior Actual
            { wch: 20 }   // Current Budget
          ];
          XLSX.utils.book_append_sheet(wb, ws_budget, 'Budget');
        }

        // Insurance sheet
        const insuranceData = [
          ['Insurance Information', ''],
          ['Company', data.insurance.company],
          ['Policy Number', data.insurance.policyNumber],
          ['Coverage Start', data.insurance.coverageStart],
          ['Coverage End', data.insurance.coverageEnd],
          ['Annual Premium', data.insurance.annualPremium],
          ['Building Coverage', data.insurance.buildingCoverage],
          ['Liability Coverage', data.insurance.liabilityCoverage],
          ['Deductible', data.insurance.deductible]
        ];
        const ws4 = XLSX.utils.aoa_to_sheet(insuranceData);
        ws4['!cols'] = [{ wch: 35 }, { wch: 20 }];
        XLSX.utils.book_append_sheet(wb, ws4, 'Insurance');

        XLSX.writeFile(wb, `strata-data-${selectedYear}.xlsx`);
      };

      // Show loading or connection prompt
      if (!isAuthenticated) {
        return (
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center', 
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
          }}>
            <div style={{
              background: 'white',
              padding: '60px',
              borderRadius: '20px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
              textAlign: 'center',
              maxWidth: '500px'
            }}>
              <div style={{ fontSize: '5rem', marginBottom: '20px' }}>â˜ï¸</div>
              <h1 style={{ color: '#667eea', marginBottom: '15px' }}>Strata Management System</h1>
              <p style={{ color: '#666', marginBottom: '30px', lineHeight: '1.6' }}>
                Connect to Google Drive to access your strata data from any device.
              </p>
              
              <button 
                onClick={async () => {
                  try {
                    await GoogleDriveManager.authenticate();
                    setIsAuthenticated(true);
                  } catch (error) {
                    alert('Connection failed. Please try again.');
                  }
                }}
                style={{
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  padding: '15px 40px',
                  fontSize: '1.1rem',
                  borderRadius: '10px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)',
                  marginBottom: '30px'
                }}
              >
                ðŸ”— Connect to Google Drive
              </button>

              <details style={{ textAlign: 'left', background: '#FEF3C7', padding: '20px', borderRadius: '10px', marginBottom: '15px', border: '2px solid #F59E0B', cursor: 'pointer' }}>
                <summary style={{ fontWeight: '600', color: '#92400E', fontSize: '1.05rem', cursor: 'pointer' }}>
                  ðŸ“‹ Connection Steps (Click to Expand)
                </summary>
                <ol style={{ marginLeft: '20px', marginTop: '12px', color: '#78350F', lineHeight: '2', fontSize: '0.95rem' }}>
                  <li>Click "Connect to Google Drive" button above</li>
                  <li>Enter email: <strong>stratavis4478@gmail.com</strong></li>
                  <li>Enter the account password</li>
                  <li>Click <strong>"Continue"</strong> on "Google hasn't verified this app" screen</li>
                  <li>Click <strong>"Continue"</strong> on "wants access to your Google Account" screen</li>
                  <li>Done! Your data will load automatically</li>
                </ol>
              </details>

              <details style={{ textAlign: 'left', background: '#E0F2FE', padding: '15px', borderRadius: '10px', border: '2px solid #0EA5E9', cursor: 'pointer' }}>
                <summary style={{ fontWeight: '600', color: '#075985', cursor: 'pointer' }}>
                  â° About Reconnecting (Click to Expand)
                </summary>
                <p style={{ color: '#0C4A6E', fontSize: '0.9rem', lineHeight: '1.6', marginTop: '12px' }}>
                  You'll need to reconnect after ~1 hour of inactivity or when you refresh the page. 
                  This is a Google security feature. Just follow the same steps above to reconnect.
                </p>
              </details>
            </div>
          </div>
        );
      }

      if (!cloudReady || !allYearsData) {
        return (
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
          }}>
            <div style={{
              background: 'white',
              padding: '60px',
              borderRadius: '20px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '4rem', marginBottom: '20px', animation: 'pulse 2s infinite' }}>â˜ï¸</div>
              <h2 style={{ color: '#667eea', marginBottom: '10px' }}>Loading Your Data...</h2>
              <p style={{ color: '#666' }}>Connecting to Google Drive</p>
            </div>
          </div>
        );
      }

      return (
        <div>
          <header className="header">
            <div className="header-content">
              <h1>Strata Management</h1>
              <p className="header-subtitle">4-Unit Strata â€¢ 700 Block, Wilson Street, Victoria, BC</p>
              <p className="header-subtitle" style={{ fontSize: '0.95rem', marginTop: '5px' }}>Strata Plan VIS4478</p>
            </div>
          </header>

          <div className="controls-bar">
            <div className="year-selector">
              <label>Year:</label>
              <select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))}>
                {yearOptions.map(year => (
                  <option key={year} value={year}>{year}</option>
                ))}
              </select>
              <button 
                onClick={addNewYear}
                className="add-button"
                style={{ padding: '10px 15px', fontSize: '0.9rem' }}
                title="Add a new year"
              >
                + Add Year
              </button>
            </div>

            <nav className="nav-tabs">
              <button 
                className={`tab-button ${activeTab === 'dashboard' ? 'active' : ''}`}
                onClick={() => setActiveTab('dashboard')}
              >
                Dashboard
              </button>
              <button 
                className={`tab-button ${activeTab === 'budgets' ? 'active' : ''}`}
                onClick={() => setActiveTab('budgets')}
              >
                Budgets
              </button>
              <button 
                className={`tab-button ${activeTab === 'fees' ? 'active' : ''}`}
                onClick={() => setActiveTab('fees')}
              >
                Strata Fees
              </button>
              <button 
                className={`tab-button ${activeTab === 'expenses' ? 'active' : ''}`}
                onClick={() => setActiveTab('expenses')}
              >
                Expenses
              </button>
              <button 
                className={`tab-button ${activeTab === 'insurance' ? 'active' : ''}`}
                onClick={() => setActiveTab('insurance')}
              >
                Insurance
              </button>
              <button 
                className={`tab-button ${activeTab === 'documents' ? 'active' : ''}`}
                onClick={() => setActiveTab('documents')}
              >
                Documents
              </button>
            </nav>

            <div className="export-buttons">
              <button className="export-button pdf" onClick={exportToPDF}>
                ðŸ“„ Export PDF
              </button>
              <button className="export-button excel" onClick={exportToExcel}>
                ðŸ“Š Export Excel
              </button>
            </div>
          </div>

          {activeTab === 'dashboard' && (
            <Dashboard data={data} totals={totals} selectedYear={selectedYear} setData={setData} />
          )}

          {activeTab === 'budgets' && (
            <BudgetsTab data={data} allYearsData={allYearsData} selectedYear={selectedYear} setData={setData} />
          )}

          {activeTab === 'fees' && (
            <StrataFeesTab data={data} updateStrataFees={updateStrataFees} />
          )}

          {activeTab === 'expenses' && (
            <ExpensesTab data={data} updateExpense={updateExpense} />
          )}

          {activeTab === 'insurance' && (
            <InsuranceTab data={data} setData={setData} />
          )}

          {activeTab === 'documents' && (
            <DocumentsTab 
              data={data} 
              setData={setData} 
              selectedYear={selectedYear} 
              permanentDocuments={permanentDocuments}
              setPermanentDocuments={setPermanentDocuments}
            />
          )}
        </div>
      );
    }

    // Dashboard Component
    function Dashboard({ data, totals, selectedYear, setData }) {
      const [dashNotes, setDashNotes] = useState(data.dashboardNotes || '');
      
      const chartData = MONTHS.map(month => {
        const fees = data.strataFees[month];
        const income = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
        
        let expenses = 0;
        Object.values(data.expenses).forEach(category => {
          expenses += category[month] || 0;
        });

        return {
          month: month.substring(0, 3),
          income,
          expenses,
          net: income - expenses
        };
      });

      const expenseBreakdown = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])].map(category => {
        let total = 0;
        Object.values(data.expenses[category.name] || {}).forEach(amount => {
          total += amount || 0;
        });
        return {
          category: category.name.replace(' (BC Hydro)', '').replace(' (Water/Sewer/Garbage)', ''),
          amount: total
        };
      }).filter(item => item.amount > 0);

      return (
        <>
          <div className="dashboard-grid">
            <div className="stat-card">
              <div className="stat-label">Total Strata Fees</div>
              <div className="stat-value">{formatCurrency(totals.income)}</div>
              <div className="stat-change positive">â†‘ Fees collected</div>
            </div>

            <div className="stat-card accent">
              <div className="stat-label">Total Expenses</div>
              <div className="stat-value">{formatCurrency(totals.expenses)}</div>
              <div className="stat-change">YTD spending</div>
            </div>

            <div className={`stat-card ${totals.surplus >= 0 ? 'success' : 'warning'}`}>
              <div className="stat-label">Net Surplus</div>
              <div className="stat-value">{formatCurrency(totals.surplus)}</div>
              <div className={`stat-change ${totals.surplus >= 0 ? 'positive' : 'negative'}`}>
                {totals.surplus >= 0 ? 'â†‘' : 'â†“'} {totals.surplus >= 0 ? 'Surplus' : 'Deficit'}
              </div>
            </div>

            <div className="stat-card">
              <div className="stat-label">CRF Balance</div>
              <div className="stat-value">{formatCurrency((data.crfBaseline || 0) + totals.surplus)}</div>
              <div className="stat-change">Reserve fund</div>
            </div>
          </div>

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Contingency Reserve Fund (CRF)</h2>
            </div>
            <div style={{ padding: '20px' }}>
              <div className="form-row">
                <div className="form-group">
                  <label>CRF Opening Balance (Start of {selectedYear})</label>
                  <input
                    type="number"
                    step="0.01"
                    className="input-field"
                    value={data.crfBaseline || ''}
                    onChange={(e) => {
                      const value = parseFloat(e.target.value) || 0;
                      setData(prev => ({ ...prev, crfBaseline: value }));
                    }}
                    placeholder="0.00"
                    style={{ fontSize: '1.1rem', fontWeight: '600' }}
                  />
                  <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px' }}>
                    Enter the total CRF balance at the start of this year
                  </small>
                </div>
              </div>
              
              <div style={{ marginTop: '20px', padding: '20px', background: '#F0F9FF', borderRadius: '12px', border: '2px solid #BFDBFE' }}>
                <h3 style={{ color: 'var(--primary)', marginBottom: '15px' }}>CRF Calculation</h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px' }}>
                  <div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Opening Balance</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700' }}>{formatCurrency(data.crfBaseline || 0)}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>This Year's Surplus</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: totals.surplus >= 0 ? 'var(--success)' : 'var(--danger)' }}>
                      {formatCurrency(totals.surplus)}
                    </div>
                  </div>
                  <div>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Projected Closing Balance</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700', color: 'var(--primary)' }}>
                      {formatCurrency((data.crfBaseline || 0) + totals.surplus)}
                    </div>
                  </div>
                </div>
                <div style={{ marginTop: '15px', padding: '12px', background: 'white', borderRadius: '8px', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                  ðŸ’¡ <strong>Tip:</strong> At year-end, copy the "Projected Closing Balance" and paste it as next year's "Opening Balance" to maintain continuity.
                </div>
              </div>
            </div>
          </div>

          {expenseBreakdown.length > 0 && (
            <div className="card">
              <div className="card-header">
                <h2 className="card-title">Expense Breakdown</h2>
              </div>
              <HorizontalBarChart data={expenseBreakdown} />
            </div>
          )}

          <div className="card">
            <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => {
              const section = document.getElementById('dash-notes-section');
              section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }}>
              <h3 style={{ fontSize: '1.1rem', color: 'var(--text-secondary)' }}>ðŸ“ Dashboard Notes & Reminders</h3>
            </div>
            <div id="dash-notes-section" style={{ padding: '20px', display: 'none' }}>
              <textarea
                value={dashNotes}
                onChange={(e) => {
                  setDashNotes(e.target.value);
                  setData(prev => ({ ...prev, dashboardNotes: e.target.value }));
                }}
                placeholder="Add reminders about CRF balance verification, upcoming expenses, or other important notes..."
                style={{
                  width: '100%',
                  minHeight: '100px',
                  padding: '12px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  fontSize: '0.95rem',
                  fontFamily: 'inherit',
                  resize: 'vertical'
                }}
              />
              <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '8px' }}>
                Use this space for CRF balance confirmations, upcoming major expenses, or other financial reminders.
              </small>
            </div>
          </div>
        </>
      );
    }

    // Budgets Tab
    function BudgetsTab({ data, allYearsData, selectedYear, setData }) {
      const [budgetNotes, setBudgetNotes] = useState(data.budgetTabNotes || '');
      const [activeNotePopup, setActiveNotePopup] = useState(null);
      const [repairsBreakdownPopup, setRepairsBreakdownPopup] = useState(null); // 'prior-proposed', 'prior-actual', or 'current'
      
      // Standard expense categories - MUST match Expenses tab exactly (NO Repairs & Maintenance - it's calculated)
      const standardCategories = [
        'Hydro (BC Hydro)',
        'City Utilities (Water/Sewer/Garbage)',
        'Strata Insurance'
      ];
      
      // Get custom categories from data, but filter out any that are actually standard
      const storedCustomCategories = (data.budgetCustomCategories || []).filter(cat => !standardCategories.includes(cat));
      const [customCategories, setCustomCategories] = useState(storedCustomCategories);
      
      // Get prior year data
      const priorYear = selectedYear - 1;
      const priorYearData = allYearsData?.[priorYear];
      
      // Calculate R&M total from marked custom expenses
      const calculateRepairsMaintenance = (yearData) => {
        if (!yearData) return { total: 0, breakdown: [] };
        
        const repairsExpenses = (yearData.customExpenses || []).filter(cat => cat.isRepairsMaintenance);
        let total = 0;
        const breakdown = [];
        
        repairsExpenses.forEach(category => {
          let categoryTotal = 0;
          if (yearData.expenses && yearData.expenses[category.name]) {
            Object.values(yearData.expenses[category.name]).forEach(amount => {
              categoryTotal += (parseFloat(amount) || 0);
            });
          }
          if (categoryTotal > 0) {
            total += categoryTotal;
            breakdown.push({ name: category.name, amount: categoryTotal });
          }
        });
        
        return { total, breakdown };
      };
      
      // Calculate prior year actual totals from expenses
      const getPriorYearActuals = () => {
        if (!priorYearData) return { fees: {}, expenses: {} };
        
        const actuals = {
          fees: { unit700: 0, unit702: 0, unit704: 0, unit706: 0 },
          expenses: {}
        };
        
        // Sum up fees from all months
        Object.values(priorYearData.strataFees || {}).forEach(month => {
          actuals.fees.unit700 += (month.unit700 || 0);
          actuals.fees.unit702 += (month.unit702 || 0);
          actuals.fees.unit704 += (month.unit704 || 0);
          actuals.fees.unit706 += (month.unit706 || 0);
        });
        
        // Sum up expenses by category - iterate through ALL categories in prior year expenses
        // EXCEPT those marked as Repairs & Maintenance (they'll be summed separately)
        if (priorYearData.expenses) {
          Object.entries(priorYearData.expenses).forEach(([category, monthlyData]) => {
            // Check if this is a R&M category
            const isRepairsMaint = (priorYearData.customExpenses || []).find(c => c.name === category && c.isRepairsMaintenance);
            if (isRepairsMaint) return; // Skip - will be included in R&M total
            
            let categoryTotal = 0;
            // monthlyData is an object with keys like 'jan', 'feb', etc.
            if (monthlyData && typeof monthlyData === 'object') {
              Object.values(monthlyData).forEach(amount => {
                categoryTotal += (parseFloat(amount) || 0);
              });
            }
            actuals.expenses[category] = categoryTotal;
          });
        }
        
        // Add R&M as calculated total
        const repairsMaint = calculateRepairsMaintenance(priorYearData);
        if (repairsMaint.total > 0) {
          actuals.expenses['Repairs & Maintenance'] = repairsMaint.total;
        }
        
        return actuals;
      };
      
      const priorYearActuals = getPriorYearActuals();
      
      // Get prior year's proposed budget (which was column 3 in prior year)
      // This is what we display in column 1 (read-only)
      const priorYearProposedBudget = priorYearData?.budget?.currentYearProposed || { fees: {}, expenses: {}, notes: {} };
      
      // Get current proposed budget (need this early for category detection)
      const currentProposed = data.budget?.currentYearProposed || { fees: {}, expenses: {}, notes: {} };
      
      // Complete list of categories to exclude from custom list
      const excludeFromCustom = [
        'Hydro (BC Hydro)',
        'City Utilities (Water/Sewer/Garbage)',
        'Strata Insurance',
        'Repairs & Maintenance' // Old data might have this
      ];
      
      // Get ONLY custom categories from prior year expenses (not standard ones AND not R&M marked categories)
      const priorYearCustomCategories = priorYearData?.expenses 
        ? Object.keys(priorYearData.expenses).filter(cat => {
            // Exclude standard categories
            if (excludeFromCustom.includes(cat)) return false;
            // Exclude categories marked as R&M
            const isRepairsMaint = (priorYearData.customExpenses || []).find(c => c.name === cat && c.isRepairsMaintenance);
            return !isRepairsMaint;
          })
        : [];
      
      // Get manually added categories from current year budget (don't show standard or R&M)
      const manuallyAddedCategories = Object.keys(currentProposed?.expenses || {}).filter(cat => 
        !excludeFromCustom.includes(cat) && !priorYearCustomCategories.includes(cat)
      );
      
      // Combine prior year categories with manually added ones
      const customCategoriesToShow = [...priorYearCustomCategories, ...manuallyAddedCategories];
      
      // All categories = standard + R&M + custom (no duplicates)
      const allCategories = [...standardCategories, 'Repairs & Maintenance', ...customCategoriesToShow];
      
      // Initialize budget data structure if not exists
      if (!data.budget) {
        setData(prev => ({
          ...prev,
          budget: {
            currentYearProposed: {
              fees: { unit700: 0, unit702: 0, unit704: 0, unit706: 0 },
              expenses: {},
              notes: {}
            }
          },
          budgetTabNotes: ''
        }));
      }
      
      const updateBudgetValue = (year, type, key, value) => {
        setData(prev => ({
          ...prev,
          budget: {
            ...prev.budget,
            [year]: {
              ...prev.budget[year],
              [type]: {
                ...prev.budget[year][type],
                [key]: parseFloat(value) || 0
              }
            }
          }
        }));
      };
      
      const updateBudgetNote = (year, key, value) => {
        setData(prev => ({
          ...prev,
          budget: {
            ...prev.budget,
            [year]: {
              ...prev.budget[year],
              notes: {
                ...prev.budget[year].notes,
                [key]: value
              }
            }
          }
        }));
      };
      
      const addCustomCategory = () => {
        const categoryName = prompt('Enter new expense category name:');
        if (categoryName && !allCategories.includes(categoryName)) {
          // Add to current year's budget expenses directly
          setData(prev => ({
            ...prev,
            budget: {
              ...prev.budget,
              currentYearProposed: {
                ...prev.budget.currentYearProposed,
                expenses: {
                  ...prev.budget.currentYearProposed.expenses,
                  [categoryName]: 0
                }
              }
            }
          }));
        }
      };
      
      const removeCustomCategory = (category) => {
        if (confirm(`Remove "${category}" from budget?`)) {
          // Remove from current year's budget
          setData(prev => {
            const newExpenses = { ...prev.budget.currentYearProposed.expenses };
            delete newExpenses[category];
            return {
              ...prev,
              budget: {
                ...prev.budget,
                currentYearProposed: {
                  ...prev.budget.currentYearProposed,
                  expenses: newExpenses
                }
              }
            };
          });
        }
      };
      
      // Calculate totals - ONLY from categories that are actually displayed
      const calculateTotals = (fees, expenses, categoriesToInclude) => {
        const feeTotal = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
        // Only sum expenses from categories that are visible in the table
        const expenseTotal = categoriesToInclude.reduce((sum, category) => {
          return sum + (parseFloat(expenses[category]) || 0);
        }, 0);
        return { feeTotal, expenseTotal, surplus: feeTotal - expenseTotal };
      };
      
      const priorProposedTotals = calculateTotals(priorYearProposedBudget.fees || {}, priorYearProposedBudget.expenses || {}, allCategories);
      const priorActualsTotals = calculateTotals(priorYearActuals.fees || {}, priorYearActuals.expenses || {}, allCategories);
      const currentProposedTotals = calculateTotals(currentProposed.fees || {}, currentProposed.expenses || {}, allCategories);
      
      return (
        <>
          <div className="card">
            <div className="card-header">
              <h2 className="card-title">
                {selectedYear} Budget Comparison
                <span style={{ fontSize: '0.9rem', fontWeight: 'normal', color: 'var(--text-secondary)', marginLeft: '15px' }}>
                  Prior Year: {priorYear}
                </span>
              </h2>
            </div>
            
            <div style={{ overflowX: 'auto', position: 'relative' }}>
              <table className="data-table" style={{ minWidth: '900px' }}>
                <thead>
                  <tr>
                    <th style={{ width: '25%', position: 'sticky', left: 0, background: '#F9FAFB', zIndex: 2 }}>Line Item</th>
                    <th style={{ width: '20%', background: '#93C5FD' }}>
                      {priorYear} Budget<br/>
                      <small style={{ fontWeight: 'normal', color: '#1E3A8A' }}>Proposed</small>
                    </th>
                    <th style={{ width: '20%', background: '#60A5FA' }}>
                      {priorYear} Actual<br/>
                      <small style={{ fontWeight: 'normal', color: '#1E3A8A' }}>From Records</small>
                    </th>
                    <th style={{ width: '20%', background: '#3B82F6' }}>
                      {selectedYear} Budget<br/>
                      <small style={{ fontWeight: 'normal', color: 'white' }}>Proposed</small>
                    </th>
                    <th style={{ width: '15%' }}>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {/* STRATA FEES SECTION */}
                  <tr style={{ background: '#F3F4F6' }}>
                    <td colSpan="5" style={{ fontWeight: '700', fontSize: '1.05rem', padding: '15px 20px' }}>
                      ðŸ“Š STRATA FEES (Income)
                    </td>
                  </tr>
                  {['unit700', 'unit702', 'unit704', 'unit706'].map(unit => {
                    const unitNum = unit.replace('unit', '');
                    const noteKey = `fee_${unit}`;
                    const hasNote = currentProposed.notes?.[noteKey];
                    return (
                      <tr key={unit}>
                        <td style={{ position: 'sticky', left: 0, background: 'white', fontWeight: '600' }}>
                          Unit {unitNum}
                        </td>
                        <td style={{ background: 'white', textAlign: 'right', fontWeight: '600', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                          {formatCurrency(priorYearProposedBudget.fees?.[unit] || 0)}
                        </td>
                        <td style={{ background: 'white', textAlign: 'right', fontWeight: '600', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                          {formatCurrency(priorYearActuals.fees?.[unit] || 0)}
                        </td>
                        <td style={{ background: 'white' }}>
                          <input
                            type="number"
                            className="input-field"
                            value={currentProposed.fees?.[unit] || ''}
                            onChange={(e) => updateBudgetValue('currentYearProposed', 'fees', unit, e.target.value)}
                            placeholder="0.00"
                          />
                        </td>
                        <td style={{ background: 'white', textAlign: 'center', position: 'relative' }}>
                          <button
                            onClick={() => setActiveNotePopup(activeNotePopup === noteKey ? null : noteKey)}
                            style={{
                              padding: '4px 8px',
                              fontSize: '0.85rem',
                              background: hasNote ? '#DBEAFE' : '#F3F4F6',
                              color: hasNote ? '#1E40AF' : '#6B7280',
                              border: hasNote ? '1px solid #93C5FD' : '1px solid #D1D5DB',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontWeight: hasNote ? '600' : 'normal'
                            }}
                          >
                            {hasNote ? 'ðŸ“' : 'âž•'} Note
                          </button>
                          {activeNotePopup === noteKey && (
                            <div style={{
                              position: 'absolute',
                              top: '100%',
                              right: 0,
                              marginTop: '5px',
                              background: 'white',
                              border: '2px solid #3B82F6',
                              borderRadius: '8px',
                              padding: '10px',
                              boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                              zIndex: 1000,
                              minWidth: '250px'
                            }}>
                              <textarea
                                value={currentProposed.notes?.[noteKey] || ''}
                                onChange={(e) => updateBudgetNote('currentYearProposed', noteKey, e.target.value)}
                                placeholder="Add note..."
                                style={{
                                  width: '100%',
                                  minHeight: '60px',
                                  padding: '8px',
                                  border: '1px solid #E5E7EB',
                                  borderRadius: '4px',
                                  fontSize: '0.9rem',
                                  fontFamily: 'inherit',
                                  resize: 'vertical'
                                }}
                              />
                              <button
                                onClick={() => setActiveNotePopup(null)}
                                style={{
                                  marginTop: '8px',
                                  padding: '4px 12px',
                                  fontSize: '0.85rem',
                                  background: '#3B82F6',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '4px',
                                  cursor: 'pointer',
                                  width: '100%'
                                }}
                              >
                                Close
                              </button>
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                  <tr style={{ fontWeight: '700', background: '#F9FAFB' }}>
                    <td style={{ position: 'sticky', left: 0, background: '#F9FAFB' }}>TOTAL FEES</td>
                    <td style={{ background: '#F9FAFB', textAlign: 'right', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                      {formatCurrency(priorProposedTotals.feeTotal)}
                    </td>
                    <td style={{ background: '#F9FAFB', textAlign: 'right', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                      {formatCurrency(priorActualsTotals.feeTotal)}
                    </td>
                    <td style={{ background: '#F9FAFB', textAlign: 'right', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                      {formatCurrency(currentProposedTotals.feeTotal)}
                    </td>
                    <td style={{ background: '#F9FAFB' }}></td>
                  </tr>
                  
                  {/* EXPENSES SECTION */}
                  <tr style={{ background: '#F3F4F6' }}>
                    <td colSpan="5" style={{ fontWeight: '700', fontSize: '1.05rem', padding: '15px 20px' }}>
                      ðŸ’° EXPENSES
                    </td>
                  </tr>
                  {allCategories.map(category => {
                    const noteKey = `expense_${category}`;
                    const hasNote = currentProposed.notes?.[noteKey];
                    const isCustom = !standardCategories.includes(category) && category !== 'Repairs & Maintenance';
                    const isRepairsMaint = category === 'Repairs & Maintenance';
                    
                    // For R&M, calculate from prior year data
                    const priorProposedRM = isRepairsMaint ? calculateRepairsMaintenance(priorYearData) : null;
                    const priorActualRM = isRepairsMaint ? calculateRepairsMaintenance(priorYearData) : null;
                    
                    return (
                      <tr key={category}>
                        <td style={{ position: 'sticky', left: 0, background: 'white', fontWeight: '600' }}>
                          {category}
                          {isRepairsMaint && (
                            <button
                              onClick={() => setRepairsBreakdownPopup(repairsBreakdownPopup ? null : 'show')}
                              style={{
                                marginLeft: '8px',
                                padding: '2px 8px',
                                fontSize: '0.75rem',
                                background: '#DBEAFE',
                                color: '#1E40AF',
                                border: '1px solid #93C5FD',
                                borderRadius: '4px',
                                cursor: 'pointer'
                              }}
                            >
                              â„¹ï¸ Details
                            </button>
                          )}
                          {isCustom && (
                            <button
                              onClick={() => removeCustomCategory(category)}
                              style={{
                                marginLeft: '8px',
                                padding: '2px 6px',
                                fontSize: '0.75rem',
                                background: '#fee2e2',
                                color: '#991b1b',
                                border: 'none',
                                borderRadius: '4px',
                                cursor: 'pointer'
                              }}
                            >
                              âœ•
                            </button>
                          )}
                        </td>
                        <td style={{ background: 'white', textAlign: 'right', fontWeight: '600', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                          {isRepairsMaint && priorProposedRM 
                            ? formatCurrency(priorYearProposedBudget.expenses?.['Repairs & Maintenance'] || 0)
                            : formatCurrency(priorYearProposedBudget.expenses?.[category] || 0)}
                        </td>
                        <td style={{ background: 'white', textAlign: 'right', fontWeight: '600', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                          {isRepairsMaint && priorActualRM
                            ? formatCurrency(priorActualRM.total)
                            : formatCurrency(priorYearActuals.expenses?.[category] || 0)}
                        </td>
                        <td style={{ background: 'white' }}>
                          <input
                            type="number"
                            className="input-field"
                            value={currentProposed.expenses?.[category] || ''}
                            onChange={(e) => updateBudgetValue('currentYearProposed', 'expenses', category, e.target.value)}
                            placeholder="0.00"
                          />
                        </td>
                        <td style={{ background: 'white', textAlign: 'center', position: 'relative' }}>
                          <button
                            onClick={() => setActiveNotePopup(activeNotePopup === noteKey ? null : noteKey)}
                            style={{
                              padding: '4px 8px',
                              fontSize: '0.85rem',
                              background: hasNote ? '#DBEAFE' : '#F3F4F6',
                              color: hasNote ? '#1E40AF' : '#6B7280',
                              border: hasNote ? '1px solid #93C5FD' : '1px solid #D1D5DB',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontWeight: hasNote ? '600' : 'normal'
                            }}
                          >
                            {hasNote ? 'ðŸ“' : 'âž•'} Note
                          </button>
                          {activeNotePopup === noteKey && (
                            <div style={{
                              position: 'absolute',
                              top: '100%',
                              right: 0,
                              marginTop: '5px',
                              background: 'white',
                              border: '2px solid #3B82F6',
                              borderRadius: '8px',
                              padding: '10px',
                              boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                              zIndex: 1000,
                              minWidth: '250px'
                            }}>
                              <textarea
                                value={currentProposed.notes?.[noteKey] || ''}
                                onChange={(e) => updateBudgetNote('currentYearProposed', noteKey, e.target.value)}
                                placeholder="Add note..."
                                style={{
                                  width: '100%',
                                  minHeight: '60px',
                                  padding: '8px',
                                  border: '1px solid #E5E7EB',
                                  borderRadius: '4px',
                                  fontSize: '0.9rem',
                                  fontFamily: 'inherit',
                                  resize: 'vertical'
                                }}
                              />
                              <button
                                onClick={() => setActiveNotePopup(null)}
                                style={{
                                  marginTop: '8px',
                                  padding: '4px 12px',
                                  fontSize: '0.85rem',
                                  background: '#3B82F6',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '4px',
                                  cursor: 'pointer',
                                  width: '100%'
                                }}
                              >
                                Close
                              </button>
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                  <tr>
                    <td colSpan="5" style={{ padding: '10px 20px', background: 'white' }}>
                      <button
                        className="add-button"
                        onClick={addCustomCategory}
                        style={{ fontSize: '0.9rem' }}
                      >
                        + Add Custom Category
                      </button>
                    </td>
                  </tr>
                  <tr style={{ fontWeight: '700', background: '#F9FAFB' }}>
                    <td style={{ position: 'sticky', left: 0, background: '#F9FAFB' }}>TOTAL EXPENSES</td>
                    <td style={{ background: '#F9FAFB', textAlign: 'right', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                      {formatCurrency(priorProposedTotals.expenseTotal)}
                    </td>
                    <td style={{ background: '#F9FAFB', textAlign: 'right', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                      {formatCurrency(priorActualsTotals.expenseTotal)}
                    </td>
                    <td style={{ background: '#F9FAFB', textAlign: 'right', fontFamily: 'Space Mono, monospace', color: '#1F2937' }}>
                      {formatCurrency(currentProposedTotals.expenseTotal)}
                    </td>
                    <td style={{ background: '#F9FAFB' }}></td>
                  </tr>
                  
                  {/* SURPLUS/DEFICIT */}
                  <tr style={{ fontWeight: '700', fontSize: '1.1rem', background: '#F3F4F6' }}>
                    <td style={{ position: 'sticky', left: 0, background: '#F3F4F6' }}>SURPLUS / (DEFICIT)</td>
                    <td style={{ 
                      background: '#F3F4F6', 
                      textAlign: 'right', 
                      fontFamily: 'Space Mono, monospace',
                      color: priorProposedTotals.surplus >= 0 ? '#059669' : '#DC2626',
                      fontWeight: '700'
                    }}>
                      {formatCurrency(priorProposedTotals.surplus)}
                    </td>
                    <td style={{ 
                      background: '#F3F4F6', 
                      textAlign: 'right', 
                      fontFamily: 'Space Mono, monospace',
                      color: priorActualsTotals.surplus >= 0 ? '#059669' : '#DC2626',
                      fontWeight: '700'
                    }}>
                      {formatCurrency(priorActualsTotals.surplus)}
                    </td>
                    <td style={{ 
                      background: '#F3F4F6', 
                      textAlign: 'right', 
                      fontFamily: 'Space Mono, monospace',
                      color: currentProposedTotals.surplus >= 0 ? '#059669' : '#DC2626',
                      fontWeight: '700'
                    }}>
                      {formatCurrency(currentProposedTotals.surplus)}
                    </td>
                    <td style={{ background: '#F3F4F6' }}></td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            {!priorYearData && (
              <div style={{ padding: '20px', background: '#FEF3C7', margin: '20px', borderRadius: '8px', border: '1px solid #FCD34D' }}>
                â„¹ï¸ <strong>Note:</strong> No data found for {priorYear}. The "{priorYear} Budget Proposed" and "{priorYear} Actual" columns will be empty until you add data for that year.
              </div>
            )}
            
            {/* Repairs & Maintenance Breakdown Popup */}
            {repairsBreakdownPopup && priorYearData && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 9999
              }} onClick={() => setRepairsBreakdownPopup(null)}>
                <div style={{
                  background: 'white',
                  borderRadius: '12px',
                  padding: '24px',
                  maxWidth: '500px',
                  width: '90%',
                  boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
                }} onClick={(e) => e.stopPropagation()}>
                  <h3 style={{ marginTop: 0, color: 'var(--primary)' }}>
                    ðŸ”§ Repairs & Maintenance Breakdown ({priorYear})
                  </h3>
                  <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '20px' }}>
                    These expense categories were marked as "Repairs & Maintenance" and are summed together:
                  </p>
                  {(() => {
                    const rmData = calculateRepairsMaintenance(priorYearData);
                    return (
                      <>
                        {rmData.breakdown.length > 0 ? (
                          <table style={{ width: '100%', marginBottom: '20px' }}>
                            <thead>
                              <tr style={{ borderBottom: '2px solid #E5E7EB' }}>
                                <th style={{ textAlign: 'left', padding: '8px', color: 'var(--text-secondary)' }}>Expense Category</th>
                                <th style={{ textAlign: 'right', padding: '8px', color: 'var(--text-secondary)' }}>Amount</th>
                              </tr>
                            </thead>
                            <tbody>
                              {rmData.breakdown.map((item, idx) => (
                                <tr key={idx} style={{ borderBottom: '1px solid #F3F4F6' }}>
                                  <td style={{ padding: '8px' }}>{item.name}</td>
                                  <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'Space Mono, monospace' }}>
                                    {formatCurrency(item.amount)}
                                  </td>
                                </tr>
                              ))}
                              <tr style={{ fontWeight: '700', borderTop: '2px solid #E5E7EB' }}>
                                <td style={{ padding: '8px' }}>TOTAL</td>
                                <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'Space Mono, monospace' }}>
                                  {formatCurrency(rmData.total)}
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        ) : (
                          <p style={{ padding: '20px', background: '#F3F4F6', borderRadius: '8px', textAlign: 'center', color: 'var(--text-secondary)' }}>
                            No expenses were marked as Repairs & Maintenance in {priorYear}
                          </p>
                        )}
                      </>
                    );
                  })()}
                  <button
                    onClick={() => setRepairsBreakdownPopup(null)}
                    className="add-button"
                    style={{ width: '100%', marginTop: '10px' }}
                  >
                    Close
                  </button>
                </div>
              </div>
            )}
          </div>
          
          <div className="card">
            <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => {
              const section = document.getElementById('budget-notes-section');
              section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }}>
              <h3 style={{ fontSize: '1.1rem', color: 'var(--text-secondary)' }}>ðŸ“ Budget Notes & Assumptions</h3>
            </div>
            <div id="budget-notes-section" style={{ padding: '20px', display: 'none' }}>
              <textarea
                value={budgetNotes}
                onChange={(e) => {
                  setBudgetNotes(e.target.value);
                  setData(prev => ({ ...prev, budgetTabNotes: e.target.value }));
                }}
                placeholder="Document budget assumptions, major changes, fee increase rationale, special projects planned..."
                style={{
                  width: '100%',
                  minHeight: '120px',
                  padding: '12px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  fontSize: '0.95rem',
                  fontFamily: 'inherit',
                  resize: 'vertical'
                }}
              />
              <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '8px' }}>
                Use this space to explain budget decisions, document assumptions, or note upcoming major expenses.
              </small>
            </div>
          </div>
        </>
      );
    }

    // Strata Fees Tab
    function StrataFeesTab({ data, updateStrataFees }) {
      const [feesNotes, setFeesNotes] = useState(data.strataFeesNotes || '');
      
      const [notesModal, setNotesModal] = useState({ isOpen: false, month: null, note: '' });

      const saveNote = (note) => {
        updateStrataFees.__setData(prev => ({
          ...prev,
          feeNotes: {
            ...prev.feeNotes,
            [notesModal.month]: note
          }
        }));
      };

      return (
        <>
          <NotesModal
            isOpen={notesModal.isOpen}
            onClose={() => setNotesModal({ isOpen: false, month: null, note: '' })}
            onSave={saveNote}
            initialNote={notesModal.note}
            title={`Notes for ${notesModal.month}`}
          />

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Monthly Strata Fees - All Units</h2>
            </div>

            <div className="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Unit 700</th>
                    <th>Unit 702</th>
                    <th>Unit 704</th>
                    <th>Unit 706</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  {MONTHS.map(month => {
                    const fees = data.strataFees[month];
                    const total = (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
                    
                    return (
                      <tr key={month}>
                        <td><strong>{month}</strong></td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit700 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit700', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`700-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `700-${month}`,
                              note: data.feeNotes?.[`700-${month}`] || ''
                            })}
                            title="Note for Unit 700"
                          >
                            ðŸ“
                          </button>
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit702 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit702', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`702-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `702-${month}`,
                              note: data.feeNotes?.[`702-${month}`] || ''
                            })}
                            title="Note for Unit 702"
                          >
                            ðŸ“
                          </button>
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit704 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit704', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`704-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `704-${month}`,
                              note: data.feeNotes?.[`704-${month}`] || ''
                            })}
                            title="Note for Unit 704"
                          >
                            ðŸ“
                          </button>
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            className="input-field"
                            value={fees.unit706 || ''}
                            onChange={(e) => updateStrataFees(month, 'unit706', e.target.value)}
                            placeholder="0.00"
                            style={{ width: '100px', display: 'inline-block' }}
                          />
                          <button
                            className={`notes-button ${(data.feeNotes && data.feeNotes[`706-${month}`]) ? 'has-note' : ''}`}
                            onClick={() => setNotesModal({
                              isOpen: true,
                              month: `706-${month}`,
                              note: data.feeNotes?.[`706-${month}`] || ''
                            })}
                            title="Note for Unit 706"
                          >
                            ðŸ“
                          </button>
                        </td>
                        <td>
                          <strong>{formatCurrency(total)}</strong>
                        </td>
                      </tr>
                    );
                  })}
                  <tr className="total-row">
                    <td>TOTAL</td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit700 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit702 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit704 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => sum + (data.strataFees[month].unit706 || 0), 0)
                        )}
                      </strong>
                    </td>
                    <td>
                      <strong>
                        {formatCurrency(
                          MONTHS.reduce((sum, month) => {
                            const fees = data.strataFees[month];
                            return sum + (fees.unit700 || 0) + (fees.unit702 || 0) + (fees.unit704 || 0) + (fees.unit706 || 0);
                          }, 0)
                        )}
                      </strong>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div className="card">
            <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => {
              const section = document.getElementById('fees-notes-section');
              section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }}>
              <h3 style={{ fontSize: '1.1rem', color: 'var(--text-secondary)' }}>ðŸ“ Strata Fees Notes</h3>
            </div>
            <div id="fees-notes-section" style={{ padding: '20px', display: 'none' }}>
              <textarea
                value={feesNotes}
                onChange={(e) => {
                  setFeesNotes(e.target.value);
                  updateStrataFees('strataFeesNotes', e.target.value);
                }}
                placeholder="Track late payments, payment arrangements, fee changes, or other strata fee notes..."
                style={{
                  width: '100%',
                  minHeight: '100px',
                  padding: '12px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  fontSize: '0.95rem',
                  fontFamily: 'inherit',
                  resize: 'vertical'
                }}
              />
              <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '8px' }}>
                Use this space for payment tracking, fee increase notes, or other reminders.
              </small>
            </div>
          </div>
        </>
      );
    }

    // Expenses Tab
    function ExpensesTab({ data, updateExpense }) {
      const [newCategoryName, setNewCategoryName] = useState('');
      const [newCategoryFrequency, setNewCategoryFrequency] = useState('onetime');
      const [isRepairsMaintenance, setIsRepairsMaintenance] = useState(false);
      const [notesModal, setNotesModal] = useState({ isOpen: false, key: null, note: '' });
      const [expensesNotes, setExpensesNotes] = useState(data.expensesTabNotes || '');

      const getFrequencyBadge = (frequency) => {
        const badges = {
          'onetime': { text: 'One-Time', class: 'danger' },
          'monthly': { text: 'Monthly', class: 'success' },
          'bimonthly': { text: 'Bi-Monthly', class: 'warning' },
          'semiannual': { text: 'Semi-Annual', class: 'warning' },
          'annual': { text: 'Annual', class: 'danger' }
        };
        return badges[frequency] || badges['monthly'];
      };

      const getMonthsForFrequency = (frequency) => {
        switch(frequency) {
          case 'onetime':
            return MONTHS; // Allow any month for one-time
          case 'bimonthly':
            return ['February', 'April', 'June', 'August', 'October', 'December'];
          case 'semiannual':
            return ['April', 'October'];
          case 'annual':
            return ['June'];
          default:
            return MONTHS;
        }
      };

      const addCustomCategory = (e, setData) => {
        e.preventDefault();
        if (!newCategoryName.trim()) return;

        const months = getMonthsForFrequency(newCategoryFrequency);
        const isRepairsMaint = document.getElementById('repairs-maintenance-checkbox').checked;
        
        const newCategory = {
          name: newCategoryName.trim(),
          frequency: newCategoryFrequency,
          months: months,
          isRepairsMaintenance: isRepairsMaint
        };

        setData(prev => {
          // Initialize expense data for this category
          const newExpenses = { ...prev.expenses };
          newExpenses[newCategory.name] = MONTHS.reduce((acc, month) => ({
            ...acc,
            [month]: 0
          }), {});

          return {
            ...prev,
            customExpenses: [...(prev.customExpenses || []), newCategory],
            expenses: newExpenses
          };
        });

        setNewCategoryName('');
        setNewCategoryFrequency('onetime');
        setIsRepairsMaintenance(false);
      };

      const deleteCustomCategory = (categoryName, setData) => {
        if (!confirm(`Delete "${categoryName}"? This will remove all data for this category.`)) return;

        setData(prev => {
          const newExpenses = { ...prev.expenses };
          delete newExpenses[categoryName];

          return {
            ...prev,
            customExpenses: (prev.customExpenses || []).filter(cat => cat.name !== categoryName),
            expenses: newExpenses
          };
        });
      };

      const saveNote = (note) => {
        updateExpense.__setData(prev => ({
          ...prev,
          expenseNotes: {
            ...prev.expenseNotes,
            [notesModal.key]: note
          }
        }));
      };

      // Combine default and custom categories
      const allCategories = [...EXPENSE_CATEGORIES, ...(data.customExpenses || [])];

      return (
        <>
          <NotesModal
            isOpen={notesModal.isOpen}
            onClose={() => setNotesModal({ isOpen: false, key: null, note: '' })}
            onSave={saveNote}
            initialNote={notesModal.note}
            title={`Notes for expense`}
          />

          <div className="card">
          <div className="card-header">
            <h2 className="card-title">Monthly Expenses by Category</h2>
          </div>

          <div className="table-container" style={{ overflowX: 'auto' }}>
            <table style={{ tableLayout: 'auto', width: '100%', minWidth: '800px' }}>
              <thead>
                <tr>
                  <th style={{ minWidth: '90px', width: '90px' }}>Month</th>
                  {allCategories.map(category => {
                    const displayName = category.name
                      .replace('(BC Hydro)', '<br/><span style="font-size: 0.7rem;">(BC Hydro)</span>')
                      .replace('(Water/Sewer/Garbage)', '<br/><span style="font-size: 0.65rem;">(Water/Sewer/Garbage)</span>');
                    
                    return (
                      <th key={category.name} style={{ 
                        minWidth: '140px',
                        maxWidth: '180px',
                        whiteSpace: 'normal',
                        wordWrap: 'break-word',
                        padding: '10px 5px'
                      }}>
                        <div dangerouslySetInnerHTML={{ __html: displayName }} style={{ 
                          wordWrap: 'break-word',
                          overflowWrap: 'break-word'
                        }} />
                        <br />
                        <span className={`badge ${getFrequencyBadge(category.frequency).class}`} style={{ fontSize: '0.6rem' }}>
                          {getFrequencyBadge(category.frequency).text}
                        </span>
                      </th>
                    );
                  })}
                  <th style={{ minWidth: '100px', width: '100px' }}>Total</th>
                </tr>
              </thead>
              <tbody>
                {MONTHS.map(month => {
                  let monthTotal = 0;
                  
                  return (
                    <tr key={month}>
                      <td><strong>{month}</strong></td>
                      {allCategories.map(category => {
                        const value = data.expenses[category.name]?.[month] || 0;
                        monthTotal += value;
                        const noteKey = `${category.name}-${month}`;
                        const hasNote = data.expenseNotes && data.expenseNotes[noteKey];
                        
                        return (
                          <td key={category.name}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px', alignItems: 'center' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '2px', width: '100%', justifyContent: 'center' }}>
                                <input
                                  type="number"
                                  step="0.01"
                                  className="input-field"
                                  value={value || ''}
                                  onChange={(e) => updateExpense(category.name, month, e.target.value)}
                                  placeholder="0.00"
                                  style={{ width: '85px', flex: '1', minWidth: '70px', maxWidth: '100px' }}
                                />
                                <button
                                  className={`notes-button ${hasNote ? 'has-note' : ''}`}
                                  onClick={() => setNotesModal({
                                    isOpen: true,
                                    key: noteKey,
                                    note: data.expenseNotes?.[noteKey] || ''
                                  })}
                                  title={hasNote ? 'Edit note' : 'Add note'}
                                >
                                  ðŸ“
                                </button>
                              </div>
                            </div>
                          </td>
                        );
                      })}
                      <td>
                        <strong>{formatCurrency(monthTotal)}</strong>
                      </td>
                    </tr>
                  );
                })}
                <tr className="total-row">
                  <td>TOTAL</td>
                  {allCategories.map(category => {
                    const categoryTotal = Object.values(data.expenses[category.name] || {}).reduce((sum, val) => sum + (val || 0), 0);
                    const isCustom = !EXPENSE_CATEGORIES.find(cat => cat.name === category.name);
                    
                    return (
                      <td key={category.name}>
                        <strong>{formatCurrency(categoryTotal)}</strong>
                        {isCustom && (
                          <button 
                            className="delete-button"
                            onClick={() => deleteCustomCategory(category.name, updateExpense.__setData)}
                            style={{ marginLeft: '4px', fontSize: '0.7rem', padding: '2px 4px' }}
                          >
                            âœ•
                          </button>
                        )}
                      </td>
                    );
                  })}
                  <td>
                    <strong>
                      {formatCurrency(
                        allCategories.reduce((total, category) => {
                          return total + Object.values(data.expenses[category.name] || {}).reduce((sum, val) => sum + (val || 0), 0);
                        }, 0)
                      )}
                    </strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div className="add-category-section">
            <h3 style={{ marginBottom: '15px', color: 'var(--primary)', fontSize: '1.1rem' }}>
              âž• Add Custom Expense Category
            </h3>
            <form className="add-category-form" onSubmit={(e) => addCustomCategory(e, updateExpense.__setData)}>
              <div className="form-group">
                <label>Category Name</label>
                <input
                  type="text"
                  className="input-field"
                  value={newCategoryName}
                  onChange={(e) => setNewCategoryName(e.target.value)}
                  placeholder="e.g., Tree Cutting, Snow Removal"
                />
              </div>
              <div className="form-group">
                <label>Billing Frequency</label>
                <select
                  className="input-field"
                  value={newCategoryFrequency}
                  onChange={(e) => setNewCategoryFrequency(e.target.value)}
                >
                  <option value="onetime">One-Time</option>
                  <option value="monthly">Monthly</option>
                  <option value="bimonthly">Bi-Monthly</option>
                  <option value="semiannual">Semi-Annual</option>
                  <option value="annual">Annual</option>
                </select>
              </div>
              <div className="form-group">
                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                  <input
                    type="checkbox"
                    checked={isRepairsMaintenance}
                    onChange={(e) => setIsRepairsMaintenance(e.target.checked)}
                    style={{ width: '18px', height: '18px' }}
                    id="repairs-maintenance-checkbox"
                  />
                  <span>ðŸ”§ Include in Repairs & Maintenance budget</span>
                </label>
                <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px', marginLeft: '26px', fontStyle: 'italic' }}>
                  This expense will be grouped under "Repairs & Maintenance" in next year's budget
                </small>
              </div>
              <button type="submit" className="add-button">
                + Add Category
              </button>
            </form>
          </div>

          <div style={{ marginTop: '20px', padding: '15px', background: '#F0F9FF', borderRadius: '8px', border: '1px solid #BFDBFE' }}>
            <strong style={{ color: '#1E40AF' }}>ðŸ’¡ Billing Schedule:</strong>
            <ul style={{ marginTop: '10px', marginLeft: '20px', color: '#1E3A8A' }}>
              <li><strong>Hydro:</strong> Billed every 2 months (Feb, Apr, Jun, Aug, Oct, Dec)</li>
              <li><strong>City Utilities:</strong> Combined water/sewer/garbage bill twice yearly (April & October)</li>
              <li><strong>Other expenses:</strong> Enter as they occur</li>
            </ul>
          </div>
        </div>

        <div className="card">
          <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => {
            const section = document.getElementById('expenses-notes-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
          }}>
            <h3 style={{ fontSize: '1.1rem', color: 'var(--text-secondary)' }}>ðŸ“ Expenses Notes</h3>
          </div>
          <div id="expenses-notes-section" style={{ padding: '20px', display: 'none' }}>
            <textarea
              value={expensesNotes}
              onChange={(e) => {
                setExpensesNotes(e.target.value);
                updateExpense('expensesTabNotes', e.target.value);
              }}
              placeholder="Track upcoming expenses, vendor contacts, maintenance schedules, or other expense-related notes..."
              style={{
                width: '100%',
                minHeight: '100px',
                padding: '12px',
                border: '2px solid #E5E7EB',
                borderRadius: '8px',
                fontSize: '0.95rem',
                fontFamily: 'inherit',
                resize: 'vertical'
              }}
            />
            <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '8px' }}>
              Use this space for vendor information, maintenance schedules, or budget planning notes.
            </small>
          </div>
        </div>
        </>
      );
    }

    // Insurance Tab
    function InsuranceTab({ data, setData }) {
      const [insuranceNotes, setInsuranceNotes] = useState(data.insuranceTabNotes || '');
      
      const updateInsurance = (field, value) => {
        setData(prev => ({
          ...prev,
          insurance: {
            ...prev.insurance,
            [field]: value
          }
        }));
      };

      return (
        <>
        <div className="card">
          <div className="card-header">
            <h2 className="card-title">Strata Insurance Details</h2>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Insurance Company</label>
              <input
                type="text"
                className="input-field"
                value={data.insurance.company || ''}
                onChange={(e) => updateInsurance('company', e.target.value)}
                placeholder="Company name"
              />
            </div>

            <div className="form-group">
              <label>Policy Number</label>
              <input
                type="text"
                className="input-field"
                value={data.insurance.policyNumber || ''}
                onChange={(e) => updateInsurance('policyNumber', e.target.value)}
                placeholder="Policy #"
              />
            </div>

            <div className="form-group">
              <label>Broker/Agent Name</label>
              <input
                type="text"
                className="input-field"
                value={data.insurance.brokerName || ''}
                onChange={(e) => updateInsurance('brokerName', e.target.value)}
                placeholder="Broker name"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Broker Contact Phone</label>
              <input
                type="tel"
                className="input-field"
                value={data.insurance.brokerPhone || ''}
                onChange={(e) => updateInsurance('brokerPhone', e.target.value)}
                placeholder="(250) 555-1234"
              />
            </div>

            <div className="form-group">
              <label>Broker Email</label>
              <input
                type="email"
                className="input-field"
                value={data.insurance.brokerEmail || ''}
                onChange={(e) => updateInsurance('brokerEmail', e.target.value)}
                placeholder="broker@insurance.com"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Coverage Start Date</label>
              <input
                type="date"
                className="input-field"
                value={data.insurance.coverageStart || ''}
                onChange={(e) => updateInsurance('coverageStart', e.target.value)}
              />
            </div>

            <div className="form-group">
              <label>Coverage End Date</label>
              <input
                type="date"
                className="input-field"
                value={data.insurance.coverageEnd || ''}
                onChange={(e) => updateInsurance('coverageEnd', e.target.value)}
              />
            </div>

            <div className="form-group">
              <label>Renewal Date</label>
              <input
                type="date"
                className="input-field"
                value={data.insurance.renewalDate || ''}
                onChange={(e) => updateInsurance('renewalDate', e.target.value)}
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Annual Premium</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.annualPremium || ''}
                onChange={(e) => updateInsurance('annualPremium', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Building Replacement Value</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.buildingCoverage || ''}
                onChange={(e) => updateInsurance('buildingCoverage', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Contents Coverage (Common Areas)</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.contentsCoverage || ''}
                onChange={(e) => updateInsurance('contentsCoverage', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Liability Coverage</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.liabilityCoverage || ''}
                onChange={(e) => updateInsurance('liabilityCoverage', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Deductible (All Perils)</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.deductible || ''}
                onChange={(e) => updateInsurance('deductible', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Earthquake Deductible</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.earthquakeDeductible || ''}
                onChange={(e) => updateInsurance('earthquakeDeductible', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
          </div>

          <div className="form-row">
            <div className="form-group">
              <label>Water Damage Deductible</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.waterDeductible || ''}
                onChange={(e) => updateInsurance('waterDeductible', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>

            <div className="form-group">
              <label>Sewer Backup Coverage</label>
              <input
                type="number"
                step="0.01"
                className="input-field"
                value={data.insurance.sewerBackup || ''}
                onChange={(e) => updateInsurance('sewerBackup', parseFloat(e.target.value) || 0)}
                placeholder="0.00"
              />
            </div>
          </div>

          <div className="form-group">
            <label>Additional Coverage Notes</label>
            <textarea
              className="input-field"
              value={data.insurance.notes || ''}
              onChange={(e) => updateInsurance('notes', e.target.value)}
              placeholder="E.g., Directors & Officers insurance, equipment breakdown, flood coverage, etc."
              style={{ minHeight: '100px', resize: 'vertical' }}
            />
          </div>

          <div style={{ marginTop: '30px', padding: '20px', background: 'var(--bg-main)', borderRadius: '12px' }}>
            <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>Insurance Summary</h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '15px' }}>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Annual Premium</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.annualPremium)}
                </div>
              </div>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Building Coverage</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.buildingCoverage)}
                </div>
              </div>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Liability Coverage</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.liabilityCoverage)}
                </div>
              </div>
              <div>
                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Standard Deductible</div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', fontFamily: 'Space Mono, monospace' }}>
                  {formatCurrency(data.insurance.deductible)}
                </div>
              </div>
            </div>
            {data.insurance.renewalDate && (
              <div style={{ marginTop: '15px', padding: '12px', background: '#FFF7ED', borderRadius: '8px', border: '1px solid #FDBA74' }}>
                <strong style={{ color: '#C2410C' }}>ðŸ“… Next Renewal:</strong>{' '}
                <span style={{ color: '#9A3412' }}>
                  {new Date(data.insurance.renewalDate).toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' })}
                </span>
              </div>
            )}
          </div>
        </div>

        <div className="card">
          <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => {
            const section = document.getElementById('insurance-notes-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
          }}>
            <h3 style={{ fontSize: '1.1rem', color: 'var(--text-secondary)' }}>ðŸ“ Insurance Notes</h3>
          </div>
          <div id="insurance-notes-section" style={{ padding: '20px', display: 'none' }}>
            <textarea
              value={insuranceNotes}
              onChange={(e) => {
                setInsuranceNotes(e.target.value);
                setData(prev => ({ ...prev, insuranceTabNotes: e.target.value }));
              }}
              placeholder="Track policy changes, broker contact info, claims history, renewal reminders, or other insurance notes..."
              style={{
                width: '100%',
                minHeight: '100px',
                padding: '12px',
                border: '2px solid #E5E7EB',
                borderRadius: '8px',
                fontSize: '0.95rem',
                fontFamily: 'inherit',
                resize: 'vertical'
              }}
            />
            <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '8px' }}>
              Use this space for broker details, coverage change history, or renewal reminders.
            </small>
          </div>
        </div>
        </>
      );
    }

    // Documents Tab
    // Documents Tab with Google Drive Integration
    function DocumentsTab({ data, setData, selectedYear, permanentDocuments, setPermanentDocuments }) {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [isUploading, setIsUploading] = useState(false);
      const [driveFiles, setDriveFiles] = useState([]);
      const [storageQuota, setStorageQuota] = useState(null);
      const [showUploadModal, setShowUploadModal] = useState(false);
      const [selectedFile, setSelectedFile] = useState(null);
      const [uploadForm, setUploadForm] = useState({ name: '', date: '', isPermanent: false, category: '' });
      const [permSectionCollapsed, setPermSectionCollapsed] = useState(false);
      const [collapsedCategories, setCollapsedCategories] = useState({
        'AGM & Council Minutes': true,
        'Building Plans, Permits & Purchase': true,
        'Bylaws & Rules': true,
        'Major Repairs & Maintenance': true,
        'Legal Documents': true,
        'Other': true
      });
      const [docsSortBy, setDocsSortBy] = useState('date');
      const [permSortBy, setPermSortBy] = useState('year');
      const [showRegulationsModal, setShowRegulationsModal] = useState(false);
      const [docNotes, setDocNotes] = useState(data.documentNotes || '');
      
      // Use permanentDocuments from props
      const permanentFiles = permanentDocuments || [];

      const sortDocuments = (docs, sortBy) => {
        const sorted = [...docs];
        if (sortBy === 'date') {
          sorted.sort((a, b) => {
            const dateA = a.description ? new Date(a.description) : new Date(a.createdTime);
            const dateB = b.description ? new Date(b.description) : new Date(b.createdTime);
            return dateB - dateA;
          });
        } else if (sortBy === 'name') {
          sorted.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === 'size') {
          sorted.sort((a, b) => (b.size || 0) - (a.size || 0));
        }
        return sorted;
      };

      const sortPermanent = (docs, sortBy) => {
        const sorted = [...docs];
        if (sortBy === 'year') {
          sorted.sort((a, b) => b.year - a.year);
        } else if (sortBy === 'name') {
          sorted.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === 'date') {
          sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
        } else if (sortBy === 'size') {
          sorted.sort((a, b) => (b.size || 0) - (a.size || 0));
        }
        return sorted;
      };

      const getYearColor = (year) => {
        // Odd years: light blue, Even years: light green
        return year % 2 === 0 ? '#ECFDF5' : '#DBEAFE';
      };

      // Check authentication status
      useEffect(() => {
        const checkAuth = async () => {
          const isAuth = await GoogleDriveManager.isAuthenticated();
          setIsAuthenticated(isAuth);
        };
        checkAuth();
      }, []);

      // Load files when authenticated
      useEffect(() => {
        if (isAuthenticated) {
          loadFiles();
          loadStorageQuota();
          // Permanent documents managed at app level, no need to set here
        }
      }, [isAuthenticated, selectedYear]);

      const loadFiles = async () => {
        try {
          const files = await GoogleDriveManager.listFiles(selectedYear);
          setDriveFiles(files);
          // Permanent files come from props, managed at app level
        } catch (error) {
          console.error('Error loading files:', error);
          alert('Error loading files. You may need to reconnect to Google Drive.');
        }
      };

      const loadStorageQuota = async () => {
        try {
          const quota = await GoogleDriveManager.getStorageQuota();
          setStorageQuota(quota);
        } catch (error) {
          console.error('Error loading quota:', error);
        }
      };

      const handleAuthenticate = async () => {
        try {
          await GoogleDriveManager.authenticate();
          setIsAuthenticated(true);
          alert('âœ… Connected to Google Drive!');
        } catch (error) {
          console.error('Auth error:', error);
          alert('Failed to connect to Google Drive. Please try again.');
        }
      };

      const handleSignOut = () => {
        GoogleDriveManager.signOut();
        setIsAuthenticated(false);
        setDriveFiles([]);
      };

      const handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        setSelectedFile(file);
        setUploadForm({
          name: file.name.replace(/\.[^/.]+$/, ''),
          date: '', // Leave blank instead of auto-filling with today
          isPermanent: false,
          category: ''
        });
        setShowUploadModal(true);
        event.target.value = '';
      };

      const handleUploadSubmit = async () => {
        if (!uploadForm.name || !uploadForm.date) {
          alert('Please fill in all required fields');
          return;
        }
        
        if (uploadForm.isPermanent && !uploadForm.category) {
          alert('Please select a category for permanent records');
          return;
        }

        setIsUploading(true);
        try {
          const result = await GoogleDriveManager.uploadFile(selectedFile, selectedYear, {
            name: uploadForm.name,
            date: uploadForm.date
          });

          if (uploadForm.isPermanent) {
            const permDoc = {
              id: result.id,
              name: uploadForm.name,
              date: uploadForm.date,
              year: selectedYear,
              category: uploadForm.category,
              driveFileId: result.id,
              webViewLink: result.webViewLink,
              size: result.size
            };

            // Add to permanent documents (managed at app level)
            setPermanentDocuments([...permanentFiles, permDoc]);
          }

          alert('âœ… File uploaded successfully!');
          await loadFiles();
          setShowUploadModal(false);
          setSelectedFile(null);
          setUploadForm({ name: '', date: '', isPermanent: false, category: '' });
        } catch (error) {
          console.error('Upload error:', error);
          const errorMsg = error.message || 'Unknown error';
          if (errorMsg.includes('session expired') || errorMsg.includes('reconnect')) {
            alert('âŒ ' + errorMsg + '\n\nThe page will reload so you can reconnect.');
            setTimeout(() => window.location.reload(), 2000);
          } else {
            alert('âŒ Upload failed: ' + errorMsg);
          }
        } finally {
          setIsUploading(false);
        }
      };

      const handleDelete = async (fileId, isPerm) => {
        if (!confirm('Delete this document?')) return;

        try {
          // Try to delete from Drive (may fail if already deleted)
          try {
            await GoogleDriveManager.deleteFile(fileId);
          } catch (driveError) {
            console.warn('File may already be deleted from Drive:', driveError);
          }

          // Remove from permanent records if exists
          const updated = permanentFiles.filter(doc => doc.driveFileId !== fileId);
          if (updated.length !== permanentFiles.length) {
            setPermanentDocuments(updated);
          }

          // Reload files list
          await loadFiles();
          alert('âœ… Document deleted from all locations');
        } catch (error) {
          console.error('Delete error:', error);
          alert('âŒ Delete failed: ' + error.message);
        }
      };

      const formatBytes = (bytes) => {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i)) + ' ' + sizes[i];
      };
      
      // Format date string without timezone shift
      const formatDateLocal = (dateString) => {
        if (!dateString) return 'â€”';
        // Parse as local date to avoid timezone shift
        const [year, month, day] = dateString.split('-');
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString();
      };

      if (!isAuthenticated) {
        return (
          <div className="card">
            <div className="card-header">
              <h2 className="card-title">ðŸ“ Document Management</h2>
            </div>
            <div style={{ padding: '60px 20px', textAlign: 'center' }}>
              <div style={{ fontSize: '4rem', marginBottom: '20px' }}>â˜ï¸</div>
              <h3 style={{ marginBottom: '15px', color: 'var(--primary)' }}>Connect to Google Drive</h3>
              <p style={{ marginBottom: '30px', color: 'var(--text-secondary)', maxWidth: '500px', margin: '0 auto 30px' }}>
                Upload, view, and download strata documents stored in Google Drive (15 GB free storage)
              </p>
              
              {/* API Status Indicator */}
              <div style={{ 
                padding: '15px', 
                background: driveApiReady ? '#ECFDF5' : '#FEF3C7', 
                borderRadius: '8px', 
                marginBottom: '20px',
                maxWidth: '500px',
                margin: '0 auto 20px'
              }}>
                <div style={{ fontSize: '0.9rem', color: driveApiReady ? '#065F46' : '#92400E' }}>
                  {driveApiReady ? 'âœ… Google Drive API Ready' : 'â³ Loading Google Drive API...'}
                </div>
                {!driveApiReady && (
                  <div style={{ fontSize: '0.8rem', color: '#78350F', marginTop: '5px' }}>
                    Please wait a few seconds...
                  </div>
                )}
              </div>
              
              <button 
                onClick={handleAuthenticate} 
                className="add-button" 
                style={{ padding: '15px 40px', fontSize: '1.1rem' }}
                disabled={!driveApiReady}
              >
                {driveApiReady ? 'ðŸ”— Connect to Google Drive' : 'â³ Please Wait...'}
              </button>
              
              <div style={{ marginTop: '30px', padding: '20px', background: '#F0F9FF', borderRadius: '12px', maxWidth: '600px', margin: '30px auto 0' }}>
                <p style={{ fontSize: '0.9rem', color: '#075985', lineHeight: '1.6', marginBottom: '15px' }}>
                  <strong>ðŸ“Œ First time setup:</strong><br/>
                  Click the button above and sign in with: <strong>stratavis4478@gmail.com</strong><br/>
                  Connection lasts ~1 hour of activity.
                </p>
                <details style={{ marginTop: '15px' }}>
                  <summary style={{ cursor: 'pointer', fontWeight: '600', color: '#0369a1' }}>
                    ðŸ“– Reconnection Steps (if needed)
                  </summary>
                  <ol style={{ marginLeft: '20px', marginTop: '10px', color: '#075985', lineHeight: '1.8', fontSize: '0.85rem' }}>
                    <li>Click "Connect to Google Drive" button</li>
                    <li>Enter email: <strong>stratavis4478@gmail.com</strong></li>
                    <li>Enter password</li>
                    <li>Click "Continue" on screen: "Google hasn't verified this app"</li>
                    <li>Click "Continue" on screen: "stratavis4478.github.io wants access"</li>
                    <li>Done! You're connected</li>
                  </ol>
                </details>
              </div>
            </div>
          </div>
        );
      }

      return (
        <>
          {showRegulationsModal && (
            <div className="upload-modal" onClick={() => setShowRegulationsModal(false)}>
              <div className="upload-modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px', maxHeight: '90vh', overflowY: 'auto' }}>
                <h3 style={{ color: 'var(--primary)', marginBottom: '20px' }}>ðŸ“‹ Strata Information & Record Keeping</h3>
                
                <div style={{ marginBottom: '20px', lineHeight: '1.8' }}>
                  <h4 style={{ color: '#374151', marginBottom: '10px' }}>Document Retention Periods (BC Strata Property Act)</h4>
                  
                  <div style={{ background: '#ECFDF5', padding: '15px', borderRadius: '8px', marginBottom: '15px', border: '2px solid #10B981' }}>
                    <strong style={{ color: '#065F46' }}>âœ“ Permanent Records (Keep Forever)</strong>
                    <ul style={{ marginLeft: '20px', marginTop: '8px', color: '#047857' }}>
                      <li>Resolutions affecting common property</li>
                      <li>Bylaws and rules</li>
                      <li>Registered strata plan (VIS4478)</li>
                      <li>Court judgments and arbitration decisions</li>
                      <li>Legal opinions</li>
                      <li>Depreciation reports</li>
                      <li>Major repair/maintenance reports (engineer reports, etc.)</li>
                      <li>Building permits and plans</li>
                      <li>Manuals, warranties, schematic drawings</li>
                      <li>Disclosure statements</li>
                    </ul>
                  </div>

                  <div style={{ background: '#FEF3C7', padding: '15px', borderRadius: '8px', marginBottom: '15px', border: '2px solid #F59E0B' }}>
                    <strong style={{ color: '#92400E' }}>â± 6-Year Records</strong>
                    <ul style={{ marginLeft: '20px', marginTop: '8px', color: '#78350F' }}>
                      <li><strong>AGM minutes, Special General Meeting minutes, Council meeting minutes</strong></li>
                      <li>Financial statements and books of account</li>
                      <li>Bank statements and cancelled cheques</li>
                      <li>Budgets</li>
                      <li>Income tax returns</li>
                      <li>Form B Information Certificates</li>
                      <li>Insurance policies (keep for 6 years after policy ends)</li>
                      <li>Contracts (keep for 6 years after contract ends)</li>
                      <li>Results of any votes</li>
                      <li>Waivers of general meetings</li>
                    </ul>
                  </div>

                  <div style={{ background: '#DBEAFE', padding: '15px', borderRadius: '8px', border: '2px solid #3B82F6' }}>
                    <strong style={{ color: '#1E40AF' }}>â± 2-Year Records</strong>
                    <ul style={{ marginLeft: '20px', marginTop: '8px', color: '#1E3A8A' }}>
                      <li>Correspondence sent or received by strata/council</li>
                    </ul>
                  </div>
                </div>

                <div style={{ background: '#F3F4F6', padding: '15px', borderRadius: '8px', marginBottom: '20px' }}>
                  <strong>ðŸ“š Full Regulations & Requirements:</strong>
                  <p style={{ marginTop: '8px', marginBottom: '12px', color: '#4B5563' }}>
                    BC Government - Strata Housing: Information and Record Keeping
                  </p>
                  <a 
                    href="https://www2.gov.bc.ca/gov/content/housing-tenancy/strata-housing/operating-a-strata/information-and-record-keeping"
                    target="_blank"
                    rel="noopener noreferrer"
                    style={{ 
                      display: 'inline-block',
                      padding: '10px 20px',
                      background: 'var(--primary)',
                      color: 'white',
                      borderRadius: '8px',
                      textDecoration: 'none',
                      fontWeight: '600'
                    }}
                  >
                    ðŸ”— View Full BC Strata Regulations
                  </a>
                </div>

                <button 
                  className="modal-button cancel" 
                  onClick={() => setShowRegulationsModal(false)}
                  style={{ width: '100%' }}
                >
                  Close
                </button>
              </div>
            </div>
          )}

          {showUploadModal && (
            <div className="upload-modal" onClick={() => setShowUploadModal(false)}>
              <div className="upload-modal-content" onClick={(e) => e.stopPropagation()}>
                <h3>Upload Document</h3>
                <div className="form-group">
                  <label>Document Name <span style={{ color: 'var(--danger)' }}>*</span></label>
                  <input
                    type="text"
                    className="input-field"
                    value={uploadForm.name}
                    onChange={(e) => setUploadForm({...uploadForm, name: e.target.value})}
                    placeholder="e.g., AGM Minutes 2025"
                  />
                </div>
                <div className="form-group">
                  <label>Date <span style={{ color: 'var(--danger)' }}>*</span></label>
                  <input
                    type="date"
                    className="input-field"
                    value={uploadForm.date}
                    onChange={(e) => setUploadForm({...uploadForm, date: e.target.value})}
                  />
                  <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px', fontStyle: 'italic' }}>
                    If day is unknown, use the 1st of the month
                  </small>
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={uploadForm.isPermanent}
                      onChange={(e) => setUploadForm({...uploadForm, isPermanent: e.target.checked, category: e.target.checked ? uploadForm.category : ''})}
                      style={{ width: '18px', height: '18px' }}
                    />
                    <span>â­ Keep as Permanent Record</span>
                  </label>
                  <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '5px', marginLeft: '26px', fontStyle: 'italic' }}>
                    Document will be visible in all years
                  </small>
                </div>
                {uploadForm.isPermanent && (
                  <div className="form-group">
                    <label>Category <span style={{ color: 'var(--danger)' }}>*</span></label>
                    <select
                      className="input-field"
                      value={uploadForm.category}
                      onChange={(e) => setUploadForm({...uploadForm, category: e.target.value})}
                      style={{ width: '100%', padding: '10px', fontSize: '1rem' }}
                    >
                      <option value="">Select a category...</option>
                      <option value="AGM & Council Minutes">ðŸ“‹ AGM & Council Minutes</option>
                      <option value="Building Plans, Permits & Purchase">ðŸ—ï¸ Building Plans, Permits & Purchase</option>
                      <option value="Bylaws & Rules">ðŸ“œ Bylaws & Rules</option>
                      <option value="Major Repairs & Maintenance">ðŸ”§ Major Repairs & Maintenance</option>
                      <option value="Legal Documents">âš–ï¸ Legal Documents</option>
                      <option value="Other">ðŸ“ Other</option>
                    </select>
                  </div>
                )}
                <div className="upload-modal-buttons">
                  <button className="modal-button cancel" onClick={() => setShowUploadModal(false)}>
                    Cancel
                  </button>
                  <button className="modal-button save" onClick={handleUploadSubmit} disabled={isUploading}>
                    {isUploading ? 'â³ Uploading...' : 'ðŸ’¾ Upload'}
                  </button>
                </div>
              </div>
            </div>
          )}

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Upload Document for {selectedYear}</h2>
              <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                <button
                  onClick={() => setShowRegulationsModal(true)}
                  className="export-button pdf"
                  style={{ fontSize: '0.85rem', padding: '8px 16px' }}
                >
                  ðŸ“‹ BC Record Keeping Rules
                </button>
                {storageQuota && (
                  <>
                    <span style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>Drive Storage:</span>
                    <div style={{ width: '200px', height: '20px', background: '#E5E7EB', borderRadius: '10px', overflow: 'hidden' }}>
                      <div style={{
                        width: `${(storageQuota.usage / storageQuota.limit) * 100}%`,
                        height: '100%',
                        background: 'var(--success)',
                        transition: 'width 0.3s'
                      }}></div>
                    </div>
                    <span style={{ fontSize: '0.85rem', fontWeight: '600' }}>
                      {formatBytes(storageQuota.usage)} / {formatBytes(storageQuota.limit)}
                    </span>
                  </>
                )}
                <button onClick={handleSignOut} className="export-button pdf" style={{ fontSize: '0.85rem' }}>
                  Sign Out
                </button>
              </div>
            </div>
            <div style={{ padding: '20px' }}>
              <div style={{ padding: '30px', border: '2px dashed #BFDBFE', borderRadius: '12px', textAlign: 'center', background: '#F0F9FF' }}>
                <div style={{ fontSize: '3rem', marginBottom: '15px' }}>ðŸ“¤</div>
                <h3 style={{ marginBottom: '10px', color: 'var(--primary)' }}>Upload Document</h3>
                <p style={{ marginBottom: '20px', color: 'var(--text-secondary)' }}>
                  Select a file to upload to Google Drive
                </p>
                <div style={{ padding: '12px', background: '#FEF3C7', borderRadius: '8px', marginBottom: '15px', border: '1px solid #FCD34D' }}>
                  <p style={{ fontSize: '0.85rem', color: '#92400E', margin: 0 }}>
                    <strong>ðŸ’¡ Tip:</strong> ZIP files must be downloaded (cannot be viewed in browser)
                  </p>
                </div>
                <input
                  type="file"
                  onChange={handleFileSelect}
                  style={{ display: 'none' }}
                  id="file-upload"
                  accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip"
                  disabled={isUploading}
                />
                <label htmlFor="file-upload" className="add-button" style={{ cursor: isUploading ? 'wait' : 'pointer', display: 'inline-block' }}>
                  {isUploading ? 'â³ Uploading...' : 'ðŸ“Ž Choose File'}
                </label>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => {
              const section = document.getElementById('doc-notes-section');
              section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }}>
              <h3 style={{ fontSize: '1.1rem', color: 'var(--text-secondary)' }}>ðŸ“ Document Notes & Reminders</h3>
            </div>
            <div id="doc-notes-section" style={{ padding: '20px', display: 'none' }}>
              <textarea
                value={docNotes}
                onChange={(e) => {
                  setDocNotes(e.target.value);
                  setData(prev => ({ ...prev, documentNotes: e.target.value }));
                }}
                placeholder="Track missing documents, renewal dates, or other reminders..."
                style={{
                  width: '100%',
                  minHeight: '100px',
                  padding: '12px',
                  border: '2px solid #E5E7EB',
                  borderRadius: '8px',
                  fontSize: '0.95rem',
                  fontFamily: 'inherit',
                  resize: 'vertical'
                }}
              />
              <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '8px' }}>
                Use this space for reminders about missing documents, upcoming renewals, etc.
              </small>
            </div>
          </div>

          <div className="card">
            <div className="card-header">
              <h2 className="card-title">Documents for {selectedYear}</h2>
              <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                <span style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>Sort by:</span>
                <button 
                  className={docsSortBy === 'date' ? 'add-button' : 'export-button pdf'}
                  onClick={() => setDocsSortBy('date')}
                  style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                >
                  Date
                </button>
                <button 
                  className={docsSortBy === 'name' ? 'add-button' : 'export-button pdf'}
                  onClick={() => setDocsSortBy('name')}
                  style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                >
                  Name
                </button>
                <button 
                  className={docsSortBy === 'size' ? 'add-button' : 'export-button pdf'}
                  onClick={() => setDocsSortBy('size')}
                  style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                >
                  Size
                </button>
              </div>
            </div>
            {driveFiles.length === 0 ? (
              <div className="empty-state">
                <h3>No documents yet</h3>
                <p>Upload documents using the button above</p>
              </div>
            ) : (
              <div className="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Document Name</th>
                      <th style={{ width: '120px' }}>Size</th>
                      <th style={{ width: '100px' }}>Date</th>
                      <th style={{ width: '200px' }}>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortDocuments(driveFiles, docsSortBy).map(file => (
                      <tr key={file.id}>
                        <td><strong>{file.name}</strong></td>
                        <td>{formatBytes(file.size)}</td>
                        <td>{formatDateLocal(file.description)}</td>
                        <td>
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <a
                              href={file.webViewLink}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="notes-button"
                              style={{ borderColor: 'var(--primary)', color: 'var(--primary)', textDecoration: 'none', display: 'inline-block' }}
                            >
                              ðŸ‘ View
                            </a>
                            <a
                              href={file.webContentLink}
                              download
                              target="_blank"
                              className="notes-button"
                              style={{ borderColor: 'var(--success)', color: 'var(--success)', textDecoration: 'none', display: 'inline-block' }}
                            >
                              â¬‡ Download
                            </a>
                            <button
                              className="delete-button"
                              onClick={() => handleDelete(file.id, false)}
                            >
                              âœ•
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {permanentFiles.length > 0 && (
            <div className="card">
              <div className="card-header" style={{ cursor: 'pointer' }} onClick={() => setPermSectionCollapsed(!permSectionCollapsed)}>
                <h2 className="card-title">
                  {permSectionCollapsed ? 'â–¶' : 'â–¼'} ðŸ“š Permanent Records ({permanentFiles.length})
                </h2>
                {!permSectionCollapsed && (
                  <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }} onClick={(e) => e.stopPropagation()}>
                    <span style={{ fontSize: '0.9rem', color: 'var(--text-secondary)' }}>Sort by:</span>
                    <button 
                      className={permSortBy === 'year' ? 'add-button' : 'export-button pdf'}
                      onClick={() => setPermSortBy('year')}
                      style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                    >
                      Year
                    </button>
                    <button 
                      className={permSortBy === 'name' ? 'add-button' : 'export-button pdf'}
                      onClick={() => setPermSortBy('name')}
                      style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                    >
                      Name
                    </button>
                    <button 
                      className={permSortBy === 'date' ? 'add-button' : 'export-button pdf'}
                      onClick={() => setPermSortBy('date')}
                      style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                    >
                      Date
                    </button>
                    <button 
                      className={permSortBy === 'size' ? 'add-button' : 'export-button pdf'}
                      onClick={() => setPermSortBy('size')}
                      style={{ padding: '6px 12px', fontSize: '0.85rem' }}
                    >
                      Size
                    </button>
                  </div>
                )}
              </div>
              
              {!permSectionCollapsed && (
                <>
                  <div style={{ padding: '15px', background: '#FFF7ED', borderRadius: '8px', margin: '20px', border: '2px solid #FDBA74' }}>
                    <strong style={{ color: '#C2410C' }}>ðŸ“Œ Permanent Archive</strong>
                    <p style={{ marginTop: '8px', color: '#9A3412', fontSize: '0.9rem' }}>
                      Documents organized by category. Click category headers to expand/collapse.
                    </p>
                  </div>

                  {['AGM & Council Minutes', 'Building Plans, Permits & Purchase', 'Bylaws & Rules', 'Major Repairs & Maintenance', 'Legal Documents', 'Other'].map(category => {
                    const categoryDocs = permanentFiles.filter(doc => doc.category === category);
                    if (categoryDocs.length === 0) return null;
                    
                    const isCollapsed = collapsedCategories[category];
                    const categoryIcons = {
                      'AGM & Council Minutes': 'ðŸ“‹',
                      'Building Plans, Permits & Purchase': 'ðŸ—ï¸',
                      'Bylaws & Rules': 'ðŸ“œ',
                      'Major Repairs & Maintenance': 'ðŸ”§',
                      'Legal Documents': 'âš–ï¸',
                      'Other': 'ðŸ“'
                    };
                    
                    return (
                      <div key={category} style={{ marginBottom: '15px' }}>
                        <div 
                          style={{ 
                            padding: '12px 20px', 
                            background: '#F3F4F6', 
                            borderRadius: '8px',
                            margin: '0 20px',
                            cursor: 'pointer',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px'
                          }}
                          onClick={() => setCollapsedCategories(prev => ({...prev, [category]: !prev[category]}))}
                        >
                          <span>{isCollapsed ? 'â–¶' : 'â–¼'}</span>
                          <span>{categoryIcons[category]} {category}</span>
                          <span style={{ marginLeft: 'auto', fontSize: '0.9rem', color: 'var(--text-secondary)' }}>
                            ({categoryDocs.length} {categoryDocs.length === 1 ? 'document' : 'documents'})
                          </span>
                        </div>
                        
                        {!isCollapsed && (
                          <div className="table-container" style={{ marginTop: '10px' }}>
                            <table>
                              <thead>
                                <tr>
                                  <th>Document Name</th>
                                  <th style={{ width: '120px' }}>Size</th>
                                  <th style={{ width: '100px' }}>Date</th>
                                  <th style={{ width: '60px' }}>Year</th>
                                  <th style={{ width: '250px' }}>Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                {sortPermanent(categoryDocs, permSortBy).map(doc => (
                                  <tr key={doc.id} style={{ background: getYearColor(doc.year) }}>
                                    <td><strong>{doc.name}</strong></td>
                                    <td>{doc.size ? formatBytes(doc.size) : 'â€”'}</td>
                                    <td>{formatDateLocal(doc.date)}</td>
                                    <td><span className="badge success">{doc.year}</span></td>
                                    <td>
                                      <div style={{ display: 'flex', gap: '8px' }}>
                                        <a
                                          href={doc.webViewLink}
                                          target="_blank"
                                          rel="noopener noreferrer"
                                          className="notes-button"
                                          style={{ borderColor: 'var(--primary)', color: 'var(--primary)', textDecoration: 'none', display: 'inline-block' }}
                                        >
                                          ðŸ‘ View
                                        </a>
                                        <a
                                          href={`https://drive.google.com/uc?export=download&id=${doc.driveFileId}`}
                                          target="_blank"
                                          className="notes-button"
                                          style={{ borderColor: 'var(--success)', color: 'var(--success)', textDecoration: 'none', display: 'inline-block' }}
                                        >
                                          â¬‡ Download
                                        </a>
                                        <button
                                          className="delete-button"
                                          onClick={() => handleDelete(doc.driveFileId, true)}
                                        >
                                          âœ•
                                        </button>
                                      </div>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </>
              )}
            </div>
          )}
        </>
      );
    }


    // Render the app
    ReactDOM.render(<StrataApp />, document.getElementById('root'));
  </script>
</body>
</html>
